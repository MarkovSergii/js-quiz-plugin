/**
 * Created by user on 28.06.2016.
 */
'use strict';

function JSQuiz(config) {

    var that = this;
    // configuration
    this.id = config.id;
    this.showRequireError = config.showRequireError;


    // system methods --------------------------------------------------
    // create quiz block select
    var createSelect = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id',item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create select
        var content = $('<div></div>');
        var select = $('<select>').attr('question_id',item.question.id).addClass(item.answerClass).attr('id','select_'+item.question.id);
        item.question.answers.forEach(function(answer){
            var o = $('<option></option>').text(answer.text).attr('value',answer.id);
            select.append(o);

        });
        // clear select
        select.prop('value', false);

        // delete error class in we change value
        select.change(function(){
            that.unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        content.append(select);
        div_item.append(header);
        div_item.append(content);
        // return select block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block input text
    var createText = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id',item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input
        var content = $('<div></div>');
        var p = $('<p></p>').addClass(item.answerClass);
        var t = $('<input>').attr('name','answer_on_question'+item.question.id).attr('question_id',item.question.id).attr('type','text');
        // delete error class in we change value
        t.focus(function(){
            that.unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        p.prepend(t);
        content.append(p);
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block chekbox group
    var createCheckBox = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id',item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create chackboxs for each answer
        item.question.answers.forEach(function(answer){
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var c = $('<input>').attr('name','answer_on_question'+item.question.id).attr('question_id',item.question.id).attr('type','checkbox').attr('value',answer.id);
            // if we have checkbox for other add other input
            if (answer.other)
            {
                c.attr('can_other','true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type','text').attr("other_input","true");
                p.append(txt);
            }

            c.click(function(){
                // delete error class in we change value
                that.unsetError($(this).attr('question_id'));
                // if check  checkbox with other attr show other input
                if  ($(this).attr('can_other')=='true')
                {
                    // if uncheck hide  other input
                     $(this).siblings().toggleClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(c);
            content.append(p);
        });
        // connect all to root div

        div_item.append(header);
        div_item.append(content);
        return div_item

    };
    //------------------------------------------------------------------
    var createRadioGroup = function (item) {

        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id',item.question.id);


        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);

        var content = $('<div></div>');
        item.question.answers.forEach(function(answer){
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var r = $('<input>').attr('name','answer_on_question'+item.question.id).attr('question_id',item.question.id).attr('type','radio').attr('value',answer.id);
            if (answer.other)
            {
                r.attr('can_other','true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type','text').attr("other_input","true");
                p.append(txt);
            }
            r.click(function(){
                that.unsetError($(this).attr('question_id'));

                if  ($(this).attr('can_other')=='true')
                {
                    $(this).siblings().removeClass('js_quiz_other_hide');
                }
                else
                {
                    $('div[js_qz_id='+item.question.id+']').find('input[other_input="true"]').addClass('js_quiz_other_hide');

                }
            });
            p.prepend(r);
            content.append(p);
        });


        div_item.append(header);
        div_item.append(content);
        return div_item
    };
    //------------------------------------------------------------------


    this.data = [];
    if (Array.isArray(config.data)) {
        this.data = config.data;
    }
    else
    {
        this.data.push(config.data)

    }

    if (this.data.length != 0)
    {
        $(that.id).html("");
        this.data.forEach(function(item){
            if ((item.question) && (item.question.id) && (item.question.text))
            {
                if (item.questionType == 'radiogroup')
                {
                    $(that.id).append(createRadioGroup(item));
                }
                if (item.questionType == 'checkbox')
                {
                    $(that.id).append(createCheckBox(item));
                }
                if (item.questionType == 'text')
                {
                    $(that.id).append(createText(item));
                }
                if (item.questionType == 'select')
                {
                    $(that.id).append(createSelect(item));
                }
            }

        });


    }

    this.getValues = function()
    {
        var is_error = false;
        var data = [];
        var err_mas_id = [];

        this.data.forEach(function(item){
            if (item.questionType == 'radiogroup')
            {
                var sel_elem = $( "input:radio[name="+"answer_on_question"+item.question.id+"]:checked" );
                var r = sel_elem.val();
                if (r == undefined)
                {
                    if (item.required)
                    {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else
                    {
                        data.push({question_id:item.question.id,answers:[{}]});
                    }

                }
                else
                {
                    if (sel_elem.attr('can_other')=='true')
                    {
                        var other = sel_elem.siblings().val();
                        data.push({question_id:item.question.id,answers:[{id:r,other:other}]});
                    }
                    else
                    {
                        data.push({question_id:item.question.id,answers:[{id:r}]});
                    }

                }

            }
            if (item.questionType == 'checkbox')
            {
                var c = $("input[name=answer_on_question"+item.question.id+"]:checked");  // array of answers
                if (c.length == 0)
                {
                    if (item.required)
                    {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else
                    {
                        data.push({question_id:item.question.id,answers:[""]});
                    }
                }
                else
                {
                    var res = [];
                    c.each(function(){

                        if ($(this).attr('can_other')=='true')
                        {
                            var other = $(this).siblings().val();
                            res.push({id:$(this).val(),other:other});
                        }
                        else
                        {
                            res.push({id:$(this).val()});
                        }

                    });

                    data.push({question_id:item.question.id,answers:res});
                }
            }
            if (item.questionType == 'text')
            {
                var t = $( "input:text[name=answer_on_question"+item.question.id+"]" ).val();
                if (t.length == 0)
                {
                    if (item.required)
                    {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else
                    {
                        data.push({question_id:item.question.id,answers:[""]});
                    }

                }
                else
                {
                    data.push({question_id:item.question.id,answers:[{text:t}]});
                }
            }
            if (item.questionType == 'select')
            {
                var s = $( '#select_'+item.question.id+' :selected' ).val();
                if (s == undefined)
                {
                    if (item.required)
                    {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else
                    {
                        data.push({question_id:item.question.id,answers:[""]});
                    }

                }
                else
                {
                    data.push({question_id:item.question.id,answers:[{id:s}]});
                }
            }
        });




        if (that.showRequireError)
        {
            err_mas_id.forEach(function(item){
                that.setError(item);
            });
        }

        return {
            error:is_error,
            data: is_error ? {} : data,
            errors_id: is_error ? err_mas_id : []
        };




    };
    this.setError = function(id){
        $('[js_qz_id = '+id+']').addClass('js_quiz_question_error_required');
    };
    this.unsetError = function(id){
        $('[js_qz_id = '+id+']').removeClass('js_quiz_question_error_required');
    };
    //------------------------------------------------------------------

}



(function($) {
    $.fn.createQuiz = function(config) {
        config = config || {};

        var conf = {
            data: config.data || [],  // array of question objects or 1 obj if 1 question
            showRequireError: ((!!config.showRequireError) || (config.showRequireError == undefined))  ? true : false,
            id: undefined

        };




        if ((!this.selector) || (!this.selector[0]=='#'))
        {
            return undefined
        }
        conf.id = this.selector;

        return new JSQuiz(conf);

    };
})(jQuery);



//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzLXF1aXotcGx1Z2luLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoianMtcXVpei1wbHVnaW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyOC4wNi4yMDE2LlxyXG4gKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuZnVuY3Rpb24gSlNRdWl6KGNvbmZpZykge1xyXG5cclxuICAgIHZhciB0aGF0ID0gdGhpcztcclxuICAgIC8vIGNvbmZpZ3VyYXRpb25cclxuICAgIHRoaXMuaWQgPSBjb25maWcuaWQ7XHJcbiAgICB0aGlzLnNob3dSZXF1aXJlRXJyb3IgPSBjb25maWcuc2hvd1JlcXVpcmVFcnJvcjtcclxuXHJcblxyXG4gICAgLy8gc3lzdGVtIG1ldGhvZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIC8vIGNyZWF0ZSBxdWl6IGJsb2NrIHNlbGVjdFxyXG4gICAgdmFyIGNyZWF0ZVNlbGVjdCA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XHJcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbi5pZCkgZGl2X2l0ZW0uYXR0cignanNfcXpfaWQnLGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBoZWFkZXJcclxuICAgICAgICB2YXIgaGVhZGVyID0gJCgnPGgzPjwvaDM+JykudGV4dChpdGVtLnF1ZXN0aW9uLnRleHQpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uQ2xhc3MpIGhlYWRlci5hZGRDbGFzcyhpdGVtLnF1ZXN0aW9uQ2xhc3MpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBzZWxlY3RcclxuICAgICAgICB2YXIgY29udGVudCA9ICQoJzxkaXY+PC9kaXY+Jyk7XHJcbiAgICAgICAgdmFyIHNlbGVjdCA9ICQoJzxzZWxlY3Q+JykuYXR0cigncXVlc3Rpb25faWQnLGl0ZW0ucXVlc3Rpb24uaWQpLmFkZENsYXNzKGl0ZW0uYW5zd2VyQ2xhc3MpLmF0dHIoJ2lkJywnc2VsZWN0XycraXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgaXRlbS5xdWVzdGlvbi5hbnN3ZXJzLmZvckVhY2goZnVuY3Rpb24oYW5zd2VyKXtcclxuICAgICAgICAgICAgdmFyIG8gPSAkKCc8b3B0aW9uPjwvb3B0aW9uPicpLnRleHQoYW5zd2VyLnRleHQpLmF0dHIoJ3ZhbHVlJyxhbnN3ZXIuaWQpO1xyXG4gICAgICAgICAgICBzZWxlY3QuYXBwZW5kKG8pO1xyXG5cclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBjbGVhciBzZWxlY3RcclxuICAgICAgICBzZWxlY3QucHJvcCgndmFsdWUnLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIC8vIGRlbGV0ZSBlcnJvciBjbGFzcyBpbiB3ZSBjaGFuZ2UgdmFsdWVcclxuICAgICAgICBzZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHRoYXQudW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIHJvb3QgZGl2XHJcbiAgICAgICAgY29udGVudC5hcHBlbmQoc2VsZWN0KTtcclxuICAgICAgICBkaXZfaXRlbS5hcHBlbmQoaGVhZGVyKTtcclxuICAgICAgICBkaXZfaXRlbS5hcHBlbmQoY29udGVudCk7XHJcbiAgICAgICAgLy8gcmV0dXJuIHNlbGVjdCBibG9ja1xyXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxyXG5cclxuICAgIH07XHJcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgLy8gY3JlYXRlIHF1aXogYmxvY2sgaW5wdXQgdGV4dFxyXG4gICAgdmFyIGNyZWF0ZVRleHQgPSBmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgIC8vIGNyZWF0ZSByb290IGRpdlxyXG4gICAgICAgIHZhciBkaXZfaXRlbSA9ICQoJzxkaXY+PC9kaXY+Jyk7XHJcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb24uaWQpIGRpdl9pdGVtLmF0dHIoJ2pzX3F6X2lkJyxpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXHJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbkNsYXNzKSBoZWFkZXIuYWRkQ2xhc3MoaXRlbS5xdWVzdGlvbkNsYXNzKTtcclxuICAgICAgICAvLyBjcmVhdGUgaW5wdXRcclxuICAgICAgICB2YXIgY29udGVudCA9ICQoJzxkaXY+PC9kaXY+Jyk7XHJcbiAgICAgICAgdmFyIHAgPSAkKCc8cD48L3A+JykuYWRkQ2xhc3MoaXRlbS5hbnN3ZXJDbGFzcyk7XHJcbiAgICAgICAgdmFyIHQgPSAkKCc8aW5wdXQ+JykuYXR0cignbmFtZScsJ2Fuc3dlcl9vbl9xdWVzdGlvbicraXRlbS5xdWVzdGlvbi5pZCkuYXR0cigncXVlc3Rpb25faWQnLGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3R5cGUnLCd0ZXh0Jyk7XHJcbiAgICAgICAgLy8gZGVsZXRlIGVycm9yIGNsYXNzIGluIHdlIGNoYW5nZSB2YWx1ZVxyXG4gICAgICAgIHQuZm9jdXMoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgdGhhdC51bnNldEVycm9yKCQodGhpcykuYXR0cigncXVlc3Rpb25faWQnKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcclxuICAgICAgICBwLnByZXBlbmQodCk7XHJcbiAgICAgICAgY29udGVudC5hcHBlbmQocCk7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIC8vIHJldHVybiBpbnB1dCBibG9ja1xyXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxyXG5cclxuICAgIH07XHJcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgLy8gY3JlYXRlIHF1aXogYmxvY2sgY2hla2JveCBncm91cFxyXG4gICAgdmFyIGNyZWF0ZUNoZWNrQm94ID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAvLyBjcmVhdGUgcm9vdCBkaXZcclxuICAgICAgICB2YXIgZGl2X2l0ZW0gPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uLmlkKSBkaXZfaXRlbS5hdHRyKCdqc19xel9pZCcsaXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgLy8gY3JlYXRlIGhlYWRlclxyXG4gICAgICAgIHZhciBoZWFkZXIgPSAkKCc8aDM+PC9oMz4nKS50ZXh0KGl0ZW0ucXVlc3Rpb24udGV4dCk7XHJcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25DbGFzcykgaGVhZGVyLmFkZENsYXNzKGl0ZW0ucXVlc3Rpb25DbGFzcyk7XHJcbiAgICAgICAgLy8gY3JlYXRlIGlucHV0IHJvb3RcclxuICAgICAgICB2YXIgY29udGVudCA9ICQoJzxkaXY+PC9kaXY+Jyk7XHJcblxyXG4gICAgICAgIC8vIGNyZWF0ZSBjaGFja2JveHMgZm9yIGVhY2ggYW5zd2VyXHJcbiAgICAgICAgaXRlbS5xdWVzdGlvbi5hbnN3ZXJzLmZvckVhY2goZnVuY3Rpb24oYW5zd2VyKXtcclxuICAgICAgICAgICAgdmFyIHAgPSAkKCc8cD48L3A+JykudGV4dChhbnN3ZXIudGV4dCkuYWRkQ2xhc3MoaXRlbS5hbnN3ZXJDbGFzcyk7XHJcbiAgICAgICAgICAgIHZhciBjID0gJCgnPGlucHV0PicpLmF0dHIoJ25hbWUnLCdhbnN3ZXJfb25fcXVlc3Rpb24nK2l0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3F1ZXN0aW9uX2lkJyxpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCd0eXBlJywnY2hlY2tib3gnKS5hdHRyKCd2YWx1ZScsYW5zd2VyLmlkKTtcclxuICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBjaGVja2JveCBmb3Igb3RoZXIgYWRkIG90aGVyIGlucHV0XHJcbiAgICAgICAgICAgIGlmIChhbnN3ZXIub3RoZXIpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGMuYXR0cignY2FuX290aGVyJywndHJ1ZScpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHR4dCA9ICQoJzxpbnB1dD4nKS5hZGRDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJykuYXR0cigndHlwZScsJ3RleHQnKS5hdHRyKFwib3RoZXJfaW5wdXRcIixcInRydWVcIik7XHJcbiAgICAgICAgICAgICAgICBwLmFwcGVuZCh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjLmNsaWNrKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXHJcbiAgICAgICAgICAgICAgICB0aGF0LnVuc2V0RXJyb3IoJCh0aGlzKS5hdHRyKCdxdWVzdGlvbl9pZCcpKTtcclxuICAgICAgICAgICAgICAgIC8vIGlmIGNoZWNrICBjaGVja2JveCB3aXRoIG90aGVyIGF0dHIgc2hvdyBvdGhlciBpbnB1dFxyXG4gICAgICAgICAgICAgICAgaWYgICgkKHRoaXMpLmF0dHIoJ2Nhbl9vdGhlcicpPT0ndHJ1ZScpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdW5jaGVjayBoaWRlICBvdGhlciBpbnB1dFxyXG4gICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnNpYmxpbmdzKCkudG9nZ2xlQ2xhc3MoJ2pzX3F1aXpfb3RoZXJfaGlkZScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gaW5wdXQgcm9vdFxyXG4gICAgICAgICAgICBwLnByZXBlbmQoYyk7XHJcbiAgICAgICAgICAgIGNvbnRlbnQuYXBwZW5kKHApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIHJvb3QgZGl2XHJcblxyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChoZWFkZXIpO1xyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcclxuICAgICAgICByZXR1cm4gZGl2X2l0ZW1cclxuXHJcbiAgICB9O1xyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIHZhciBjcmVhdGVSYWRpb0dyb3VwID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuXHJcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbi5pZCkgZGl2X2l0ZW0uYXR0cignanNfcXpfaWQnLGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG5cclxuXHJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbkNsYXNzKSBoZWFkZXIuYWRkQ2xhc3MoaXRlbS5xdWVzdGlvbkNsYXNzKTtcclxuXHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIGl0ZW0ucXVlc3Rpb24uYW5zd2Vycy5mb3JFYWNoKGZ1bmN0aW9uKGFuc3dlcil7XHJcbiAgICAgICAgICAgIHZhciBwID0gJCgnPHA+PC9wPicpLnRleHQoYW5zd2VyLnRleHQpLmFkZENsYXNzKGl0ZW0uYW5zd2VyQ2xhc3MpO1xyXG4gICAgICAgICAgICB2YXIgciA9ICQoJzxpbnB1dD4nKS5hdHRyKCduYW1lJywnYW5zd2VyX29uX3F1ZXN0aW9uJytpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCdxdWVzdGlvbl9pZCcsaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigndHlwZScsJ3JhZGlvJykuYXR0cigndmFsdWUnLGFuc3dlci5pZCk7XHJcbiAgICAgICAgICAgIGlmIChhbnN3ZXIub3RoZXIpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHIuYXR0cignY2FuX290aGVyJywndHJ1ZScpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHR4dCA9ICQoJzxpbnB1dD4nKS5hZGRDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJykuYXR0cigndHlwZScsJ3RleHQnKS5hdHRyKFwib3RoZXJfaW5wdXRcIixcInRydWVcIik7XHJcbiAgICAgICAgICAgICAgICBwLmFwcGVuZCh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHIuY2xpY2soZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgIHRoYXQudW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICAoJCh0aGlzKS5hdHRyKCdjYW5fb3RoZXInKT09J3RydWUnKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICQodGhpcykuc2libGluZ3MoKS5yZW1vdmVDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCgnZGl2W2pzX3F6X2lkPScraXRlbS5xdWVzdGlvbi5pZCsnXScpLmZpbmQoJ2lucHV0W290aGVyX2lucHV0PVwidHJ1ZVwiXScpLmFkZENsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwLnByZXBlbmQocik7XHJcbiAgICAgICAgICAgIGNvbnRlbnQuYXBwZW5kKHApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxyXG4gICAgfTtcclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG5cclxuICAgIHRoaXMuZGF0YSA9IFtdO1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoY29uZmlnLmRhdGEpKSB7XHJcbiAgICAgICAgdGhpcy5kYXRhID0gY29uZmlnLmRhdGE7XHJcbiAgICB9XHJcbiAgICBlbHNlXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5kYXRhLnB1c2goY29uZmlnLmRhdGEpXHJcblxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmRhdGEubGVuZ3RoICE9IDApXHJcbiAgICB7XHJcbiAgICAgICAgJCh0aGF0LmlkKS5odG1sKFwiXCIpO1xyXG4gICAgICAgIHRoaXMuZGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pe1xyXG4gICAgICAgICAgICBpZiAoKGl0ZW0ucXVlc3Rpb24pICYmIChpdGVtLnF1ZXN0aW9uLmlkKSAmJiAoaXRlbS5xdWVzdGlvbi50ZXh0KSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdyYWRpb2dyb3VwJylcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAkKHRoYXQuaWQpLmFwcGVuZChjcmVhdGVSYWRpb0dyb3VwKGl0ZW0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAnY2hlY2tib3gnKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGNyZWF0ZUNoZWNrQm94KGl0ZW0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAndGV4dCcpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCh0aGF0LmlkKS5hcHBlbmQoY3JlYXRlVGV4dChpdGVtKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3NlbGVjdCcpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgJCh0aGF0LmlkKS5hcHBlbmQoY3JlYXRlU2VsZWN0KGl0ZW0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZ2V0VmFsdWVzID0gZnVuY3Rpb24oKVxyXG4gICAge1xyXG4gICAgICAgIHZhciBpc19lcnJvciA9IGZhbHNlO1xyXG4gICAgICAgIHZhciBkYXRhID0gW107XHJcbiAgICAgICAgdmFyIGVycl9tYXNfaWQgPSBbXTtcclxuXHJcbiAgICAgICAgdGhpcy5kYXRhLmZvckVhY2goZnVuY3Rpb24oaXRlbSl7XHJcbiAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAncmFkaW9ncm91cCcpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHZhciBzZWxfZWxlbSA9ICQoIFwiaW5wdXQ6cmFkaW9bbmFtZT1cIitcImFuc3dlcl9vbl9xdWVzdGlvblwiK2l0ZW0ucXVlc3Rpb24uaWQrXCJdOmNoZWNrZWRcIiApO1xyXG4gICAgICAgICAgICAgICAgdmFyIHIgPSBzZWxfZWxlbS52YWwoKTtcclxuICAgICAgICAgICAgICAgIGlmIChyID09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZClcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycl9tYXNfaWQucHVzaChpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOml0ZW0ucXVlc3Rpb24uaWQsYW5zd2Vyczpbe31dfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsX2VsZW0uYXR0cignY2FuX290aGVyJyk9PSd0cnVlJylcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvdGhlciA9IHNlbF9lbGVtLnNpYmxpbmdzKCkudmFsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6aXRlbS5xdWVzdGlvbi5pZCxhbnN3ZXJzOlt7aWQ6cixvdGhlcjpvdGhlcn1dfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6aXRlbS5xdWVzdGlvbi5pZCxhbnN3ZXJzOlt7aWQ6cn1dfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdjaGVja2JveCcpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHZhciBjID0gJChcImlucHV0W25hbWU9YW5zd2VyX29uX3F1ZXN0aW9uXCIraXRlbS5xdWVzdGlvbi5pZCtcIl06Y2hlY2tlZFwiKTsgIC8vIGFycmF5IG9mIGFuc3dlcnNcclxuICAgICAgICAgICAgICAgIGlmIChjLmxlbmd0aCA9PSAwKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnJlcXVpcmVkKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19lcnJvciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6aXRlbS5xdWVzdGlvbi5pZCxhbnN3ZXJzOltcIlwiXX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgYy5lYWNoKGZ1bmN0aW9uKCl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdjYW5fb3RoZXInKT09J3RydWUnKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3RoZXIgPSAkKHRoaXMpLnNpYmxpbmdzKCkudmFsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMucHVzaCh7aWQ6JCh0aGlzKS52YWwoKSxvdGhlcjpvdGhlcn0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnB1c2goe2lkOiQodGhpcykudmFsKCl9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDppdGVtLnF1ZXN0aW9uLmlkLGFuc3dlcnM6cmVzfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICd0ZXh0JylcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdmFyIHQgPSAkKCBcImlucHV0OnRleHRbbmFtZT1hbnN3ZXJfb25fcXVlc3Rpb25cIitpdGVtLnF1ZXN0aW9uLmlkK1wiXVwiICkudmFsKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodC5sZW5ndGggPT0gMClcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZClcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycl9tYXNfaWQucHVzaChpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOml0ZW0ucXVlc3Rpb24uaWQsYW5zd2VyczpbXCJcIl19KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6aXRlbS5xdWVzdGlvbi5pZCxhbnN3ZXJzOlt7dGV4dDp0fV19KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3NlbGVjdCcpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHZhciBzID0gJCggJyNzZWxlY3RfJytpdGVtLnF1ZXN0aW9uLmlkKycgOnNlbGVjdGVkJyApLnZhbCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHMgPT0gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnJlcXVpcmVkKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19lcnJvciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6aXRlbS5xdWVzdGlvbi5pZCxhbnN3ZXJzOltcIlwiXX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDppdGVtLnF1ZXN0aW9uLmlkLGFuc3dlcnM6W3tpZDpzfV19KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcblxyXG5cclxuICAgICAgICBpZiAodGhhdC5zaG93UmVxdWlyZUVycm9yKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgZXJyX21hc19pZC5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pe1xyXG4gICAgICAgICAgICAgICAgdGhhdC5zZXRFcnJvcihpdGVtKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBlcnJvcjppc19lcnJvcixcclxuICAgICAgICAgICAgZGF0YTogaXNfZXJyb3IgPyB7fSA6IGRhdGEsXHJcbiAgICAgICAgICAgIGVycm9yc19pZDogaXNfZXJyb3IgPyBlcnJfbWFzX2lkIDogW11cclxuICAgICAgICB9O1xyXG5cclxuXHJcblxyXG5cclxuICAgIH07XHJcbiAgICB0aGlzLnNldEVycm9yID0gZnVuY3Rpb24oaWQpe1xyXG4gICAgICAgICQoJ1tqc19xel9pZCA9ICcraWQrJ10nKS5hZGRDbGFzcygnanNfcXVpel9xdWVzdGlvbl9lcnJvcl9yZXF1aXJlZCcpO1xyXG4gICAgfTtcclxuICAgIHRoaXMudW5zZXRFcnJvciA9IGZ1bmN0aW9uKGlkKXtcclxuICAgICAgICAkKCdbanNfcXpfaWQgPSAnK2lkKyddJykucmVtb3ZlQ2xhc3MoJ2pzX3F1aXpfcXVlc3Rpb25fZXJyb3JfcmVxdWlyZWQnKTtcclxuICAgIH07XHJcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG5cclxufVxyXG5cclxuXHJcblxyXG4oZnVuY3Rpb24oJCkge1xyXG4gICAgJC5mbi5jcmVhdGVRdWl6ID0gZnVuY3Rpb24oY29uZmlnKSB7XHJcbiAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xyXG5cclxuICAgICAgICB2YXIgY29uZiA9IHtcclxuICAgICAgICAgICAgZGF0YTogY29uZmlnLmRhdGEgfHwgW10sICAvLyBhcnJheSBvZiBxdWVzdGlvbiBvYmplY3RzIG9yIDEgb2JqIGlmIDEgcXVlc3Rpb25cclxuICAgICAgICAgICAgc2hvd1JlcXVpcmVFcnJvcjogKCghIWNvbmZpZy5zaG93UmVxdWlyZUVycm9yKSB8fCAoY29uZmlnLnNob3dSZXF1aXJlRXJyb3IgPT0gdW5kZWZpbmVkKSkgID8gdHJ1ZSA6IGZhbHNlLFxyXG4gICAgICAgICAgICBpZDogdW5kZWZpbmVkXHJcblxyXG4gICAgICAgIH07XHJcblxyXG5cclxuXHJcblxyXG4gICAgICAgIGlmICgoIXRoaXMuc2VsZWN0b3IpIHx8ICghdGhpcy5zZWxlY3RvclswXT09JyMnKSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uZi5pZCA9IHRoaXMuc2VsZWN0b3I7XHJcblxyXG4gICAgICAgIHJldHVybiBuZXcgSlNRdWl6KGNvbmYpO1xyXG5cclxuICAgIH07XHJcbn0pKGpRdWVyeSk7XHJcblxyXG5cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
