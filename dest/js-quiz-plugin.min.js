/**
 * Created by user on 28.06.2016.
 */
'use strict';

function JSQuiz(config) {

    var that = this;
    // configuration
    this.id = config.id;
    this.showRequireError = config.showRequireError;

    this.submitButton = config.submitButton;
    this.submitFunction = config.submitFunction;
    this.submitButtonClass = config.submitButtonClass;
    this.submitButtonText = config.submitButtonText;

    this.data = [];
    if (Array.isArray(config.data)) {
        this.data = config.data;
    }
    else {
        this.data.push(config.data)
    }

    var setError = function (id) {
        $('[js_qz_id = ' + id + ']').addClass('js_quiz_question_error_required');
    };
    var unsetError = function (id) {
        $('[js_qz_id = ' + id + ']').removeClass('js_quiz_question_error_required');
    };

    // system methods --------------------------------------------------
    // create quiz
    var run = function (it) {
        if (it.data.length != 0) {
            $(that.id).html("");
            // create all blocks
            it.data.forEach(function (item) {
                if ((item.question) && (item.question.id) && (item.question.text)) {
                    if (item.questionType == 'radiogroup') {
                        $(that.id).append(createRadioGroup(item));
                    }
                    if (item.questionType == 'checkbox') {
                        $(that.id).append(createCheckBox(item));
                    }
                    if (item.questionType == 'text') {
                        $(that.id).append(createText(item));
                    }
                    if (item.questionType == 'select') {
                        $(that.id).append(createSelect(item));
                    }
                }

            });
            // check if need create button
            if (it.submitButton)
            {
                var btn_div = $('<div></div>').addClass(it.submitButtonClass);
                var btn = $('<button></button>').text(it.submitButtonText).click(function(){

                    if (typeof it.submitFunction == 'function')
                    {
                        it.submitFunction.call(null,it.getValues());
                    }

                });

                btn_div.append(btn);
                $(that.id).append(btn_div);
            }


        }
    };

    var createSelect = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create select
        var content = $('<div></div>');
        var select = $('<select>').attr('question_id', item.question.id).addClass(item.answerClass).attr('id', 'select_' + item.question.id);
        item.question.answers.forEach(function (answer) {
            var o = $('<option></option>').text(answer.text).attr('value', answer.id);
            select.append(o);

        });
        // clear select
        select.prop('value', false);

        // delete error class in we change value
        select.change(function () {
            unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        content.append(select);
        div_item.append(header);
        div_item.append(content);
        // return select block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block input text
    var createText = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input
        var content = $('<div></div>');
        var p = $('<p></p>').addClass(item.answerClass);
        var t = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'text');
        // delete error class in we change value
        t.focus(function () {
            unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        p.prepend(t);
        content.append(p);
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block chekbox group
    var createCheckBox = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create chackboxs for each answer
        item.question.answers.forEach(function (answer) {
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var c = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'checkbox').attr('value', answer.id);
            // if we have checkbox for other add other input
            if (answer.other) {
                c.attr('can_other', 'true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type', 'text').attr("other_input", "true");
                p.append(txt);
            }

            c.click(function () {
                // delete error class in we change value
                unsetError($(this).attr('question_id'));
                // if check  checkbox with other attr show other input
                if ($(this).attr('can_other') == 'true') {
                    // if uncheck hide  other input
                    $(this).siblings().toggleClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(c);
            content.append(p);
        });
        // connect all to root div
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    var createRadioGroup = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create radio for each answer
        item.question.answers.forEach(function (answer) {
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var r = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'radio').attr('value', answer.id);
            // if we have checkbox for other add other input
            if (answer.other) {
                r.attr('can_other', 'true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type', 'text').attr("other_input", "true");
                p.append(txt);
            }
            r.click(function () {
                // delete error class in we change value
                unsetError($(this).attr('question_id'));

                if ($(this).attr('can_other') == 'true') {
                    // if check  radio with other attr show other input
                    $(this).siblings().removeClass('js_quiz_other_hide');
                }
                else {
                    // if check other radio set unisible all other inputs
                    $('div[js_qz_id=' + item.question.id + ']').find('input[other_input="true"]').addClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(r);
            content.append(p);
        });

        // connect all to root div
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item
    };



    //------------------------------------------------------------------

    // method for returning values from quiz
    this.getValues = function () {
        var is_error = false;
        var data = [];
        var err_mas_id = [];

        this.data.forEach(function (item) {
            if (item.questionType == 'radiogroup') {
                var sel_elem = $("input:radio[name=" + "answer_on_question" + item.question.id + "]:checked");
                var r = sel_elem.val();
                if (r == undefined) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [{}]});
                    }

                }
                else {
                    if (sel_elem.attr('can_other') == 'true') {
                        var other = sel_elem.siblings().val();
                        data.push({question_id: item.question.id, answers: [{id: r, other: other}]});
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [{id: r}]});
                    }

                }

            }
            if (item.questionType == 'checkbox') {
                var c = $("input[name=answer_on_question" + item.question.id + "]:checked");  // array of answers
                if (c.length == 0) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }
                }
                else {
                    var res = [];
                    c.each(function () {

                        if ($(this).attr('can_other') == 'true') {
                            var other = $(this).siblings().val();
                            res.push({id: $(this).val(), other: other});
                        }
                        else {
                            res.push({id: $(this).val()});
                        }

                    });

                    data.push({question_id: item.question.id, answers: res});
                }
            }
            if (item.questionType == 'text') {
                var t = $("input:text[name=answer_on_question" + item.question.id + "]").val();
                if (t.length == 0) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }

                }
                else {
                    data.push({question_id: item.question.id, answers: [{text: t}]});
                }
            }
            if (item.questionType == 'select') {
                var s = $('#select_' + item.question.id + ' :selected').val();
                if (s == undefined) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }

                }
                else {
                    data.push({question_id: item.question.id, answers: [{id: s}]});
                }
            }
        });


        // if global settings show error enabled then show it
        if (that.showRequireError) {
            err_mas_id.forEach(function (item) {
                setError(item);
            });
        }

        return {
            // return result or error
            error: is_error,
            data: is_error ? {} : data,
            errors_id: is_error ? err_mas_id : []
        };
    };

    //------------------------------------------------------------------
    run(this);
}


(function ($) {
    $.fn.createQuiz = function (config) {
        config = config || {};

        var conf = {
            data: config.data || [],  // array of question objects or 1 obj if 1 question
            showRequireError: ((!!config.showRequireError) || (config.showRequireError == undefined)) ? true : false,
            submitButton : config.submitButton || false,
            submitFunction : config.submitFunction || undefined,
            submitButtonText : config.submitButtonText || "Submit",
            submitButtonClass : config.submitButtonClass || "",
            id: undefined

        };


        if ((!this.selector) || (!this.selector[0] == '#')) {
            return undefined
        }
        conf.id = this.selector;

        return new JSQuiz(conf);
    };
})(jQuery);



//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzLXF1aXotcGx1Z2luLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImpzLXF1aXotcGx1Z2luLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDI4LjA2LjIwMTYuXG4gKi9cbid1c2Ugc3RyaWN0JztcblxuZnVuY3Rpb24gSlNRdWl6KGNvbmZpZykge1xuXG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgIC8vIGNvbmZpZ3VyYXRpb25cbiAgICB0aGlzLmlkID0gY29uZmlnLmlkO1xuICAgIHRoaXMuc2hvd1JlcXVpcmVFcnJvciA9IGNvbmZpZy5zaG93UmVxdWlyZUVycm9yO1xuXG4gICAgdGhpcy5zdWJtaXRCdXR0b24gPSBjb25maWcuc3VibWl0QnV0dG9uO1xuICAgIHRoaXMuc3VibWl0RnVuY3Rpb24gPSBjb25maWcuc3VibWl0RnVuY3Rpb247XG4gICAgdGhpcy5zdWJtaXRCdXR0b25DbGFzcyA9IGNvbmZpZy5zdWJtaXRCdXR0b25DbGFzcztcbiAgICB0aGlzLnN1Ym1pdEJ1dHRvblRleHQgPSBjb25maWcuc3VibWl0QnV0dG9uVGV4dDtcblxuICAgIHRoaXMuZGF0YSA9IFtdO1xuICAgIGlmIChBcnJheS5pc0FycmF5KGNvbmZpZy5kYXRhKSkge1xuICAgICAgICB0aGlzLmRhdGEgPSBjb25maWcuZGF0YTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHRoaXMuZGF0YS5wdXNoKGNvbmZpZy5kYXRhKVxuICAgIH1cblxuICAgIHZhciBzZXRFcnJvciA9IGZ1bmN0aW9uIChpZCkge1xuICAgICAgICAkKCdbanNfcXpfaWQgPSAnICsgaWQgKyAnXScpLmFkZENsYXNzKCdqc19xdWl6X3F1ZXN0aW9uX2Vycm9yX3JlcXVpcmVkJyk7XG4gICAgfTtcbiAgICB2YXIgdW5zZXRFcnJvciA9IGZ1bmN0aW9uIChpZCkge1xuICAgICAgICAkKCdbanNfcXpfaWQgPSAnICsgaWQgKyAnXScpLnJlbW92ZUNsYXNzKCdqc19xdWl6X3F1ZXN0aW9uX2Vycm9yX3JlcXVpcmVkJyk7XG4gICAgfTtcblxuICAgIC8vIHN5c3RlbSBtZXRob2RzIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gY3JlYXRlIHF1aXpcbiAgICB2YXIgcnVuID0gZnVuY3Rpb24gKGl0KSB7XG4gICAgICAgIGlmIChpdC5kYXRhLmxlbmd0aCAhPSAwKSB7XG4gICAgICAgICAgICAkKHRoYXQuaWQpLmh0bWwoXCJcIik7XG4gICAgICAgICAgICAvLyBjcmVhdGUgYWxsIGJsb2Nrc1xuICAgICAgICAgICAgaXQuZGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgaWYgKChpdGVtLnF1ZXN0aW9uKSAmJiAoaXRlbS5xdWVzdGlvbi5pZCkgJiYgKGl0ZW0ucXVlc3Rpb24udGV4dCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdyYWRpb2dyb3VwJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGF0LmlkKS5hcHBlbmQoY3JlYXRlUmFkaW9Hcm91cChpdGVtKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdjaGVja2JveCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGNyZWF0ZUNoZWNrQm94KGl0ZW0pKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3RleHQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoYXQuaWQpLmFwcGVuZChjcmVhdGVUZXh0KGl0ZW0pKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3NlbGVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGNyZWF0ZVNlbGVjdChpdGVtKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gY2hlY2sgaWYgbmVlZCBjcmVhdGUgYnV0dG9uXG4gICAgICAgICAgICBpZiAoaXQuc3VibWl0QnV0dG9uKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHZhciBidG5fZGl2ID0gJCgnPGRpdj48L2Rpdj4nKS5hZGRDbGFzcyhpdC5zdWJtaXRCdXR0b25DbGFzcyk7XG4gICAgICAgICAgICAgICAgdmFyIGJ0biA9ICQoJzxidXR0b24+PC9idXR0b24+JykudGV4dChpdC5zdWJtaXRCdXR0b25UZXh0KS5jbGljayhmdW5jdGlvbigpe1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXQuc3VibWl0RnVuY3Rpb24gPT0gJ2Z1bmN0aW9uJylcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXQuc3VibWl0RnVuY3Rpb24uY2FsbChudWxsLGl0LmdldFZhbHVlcygpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBidG5fZGl2LmFwcGVuZChidG4pO1xuICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGJ0bl9kaXYpO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB2YXIgY3JlYXRlU2VsZWN0ID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XG4gICAgICAgIHZhciBkaXZfaXRlbSA9ICQoJzxkaXY+PC9kaXY+Jyk7XG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uLmlkKSBkaXZfaXRlbS5hdHRyKCdqc19xel9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpO1xuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXG4gICAgICAgIHZhciBoZWFkZXIgPSAkKCc8aDM+PC9oMz4nKS50ZXh0KGl0ZW0ucXVlc3Rpb24udGV4dCk7XG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uQ2xhc3MpIGhlYWRlci5hZGRDbGFzcyhpdGVtLnF1ZXN0aW9uQ2xhc3MpO1xuICAgICAgICAvLyBjcmVhdGUgc2VsZWN0XG4gICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdj48L2Rpdj4nKTtcbiAgICAgICAgdmFyIHNlbGVjdCA9ICQoJzxzZWxlY3Q+JykuYXR0cigncXVlc3Rpb25faWQnLCBpdGVtLnF1ZXN0aW9uLmlkKS5hZGRDbGFzcyhpdGVtLmFuc3dlckNsYXNzKS5hdHRyKCdpZCcsICdzZWxlY3RfJyArIGl0ZW0ucXVlc3Rpb24uaWQpO1xuICAgICAgICBpdGVtLnF1ZXN0aW9uLmFuc3dlcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5zd2VyKSB7XG4gICAgICAgICAgICB2YXIgbyA9ICQoJzxvcHRpb24+PC9vcHRpb24+JykudGV4dChhbnN3ZXIudGV4dCkuYXR0cigndmFsdWUnLCBhbnN3ZXIuaWQpO1xuICAgICAgICAgICAgc2VsZWN0LmFwcGVuZChvKTtcblxuICAgICAgICB9KTtcbiAgICAgICAgLy8gY2xlYXIgc2VsZWN0XG4gICAgICAgIHNlbGVjdC5wcm9wKCd2YWx1ZScsIGZhbHNlKTtcblxuICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXG4gICAgICAgIHNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcbiAgICAgICAgY29udGVudC5hcHBlbmQoc2VsZWN0KTtcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcbiAgICAgICAgLy8gcmV0dXJuIHNlbGVjdCBibG9ja1xuICAgICAgICByZXR1cm4gZGl2X2l0ZW1cblxuICAgIH07XG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBjcmVhdGUgcXVpeiBibG9jayBpbnB1dCB0ZXh0XG4gICAgdmFyIGNyZWF0ZVRleHQgPSBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAvLyBjcmVhdGUgcm9vdCBkaXZcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb24uaWQpIGRpdl9pdGVtLmF0dHIoJ2pzX3F6X2lkJywgaXRlbS5xdWVzdGlvbi5pZCk7XG4gICAgICAgIC8vIGNyZWF0ZSBoZWFkZXJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25DbGFzcykgaGVhZGVyLmFkZENsYXNzKGl0ZW0ucXVlc3Rpb25DbGFzcyk7XG4gICAgICAgIC8vIGNyZWF0ZSBpbnB1dFxuICAgICAgICB2YXIgY29udGVudCA9ICQoJzxkaXY+PC9kaXY+Jyk7XG4gICAgICAgIHZhciBwID0gJCgnPHA+PC9wPicpLmFkZENsYXNzKGl0ZW0uYW5zd2VyQ2xhc3MpO1xuICAgICAgICB2YXIgdCA9ICQoJzxpbnB1dD4nKS5hdHRyKCduYW1lJywgJ2Fuc3dlcl9vbl9xdWVzdGlvbicgKyBpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCdxdWVzdGlvbl9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3R5cGUnLCAndGV4dCcpO1xuICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXG4gICAgICAgIHQuZm9jdXMoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcbiAgICAgICAgcC5wcmVwZW5kKHQpO1xuICAgICAgICBjb250ZW50LmFwcGVuZChwKTtcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcbiAgICAgICAgLy8gcmV0dXJuIGlucHV0IGJsb2NrXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxuXG4gICAgfTtcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIGNyZWF0ZSBxdWl6IGJsb2NrIGNoZWtib3ggZ3JvdXBcbiAgICB2YXIgY3JlYXRlQ2hlY2tCb3ggPSBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAvLyBjcmVhdGUgcm9vdCBkaXZcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb24uaWQpIGRpdl9pdGVtLmF0dHIoJ2pzX3F6X2lkJywgaXRlbS5xdWVzdGlvbi5pZCk7XG4gICAgICAgIC8vIGNyZWF0ZSBoZWFkZXJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25DbGFzcykgaGVhZGVyLmFkZENsYXNzKGl0ZW0ucXVlc3Rpb25DbGFzcyk7XG4gICAgICAgIC8vIGNyZWF0ZSBpbnB1dCByb290XG4gICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdj48L2Rpdj4nKTtcblxuICAgICAgICAvLyBjcmVhdGUgY2hhY2tib3hzIGZvciBlYWNoIGFuc3dlclxuICAgICAgICBpdGVtLnF1ZXN0aW9uLmFuc3dlcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5zd2VyKSB7XG4gICAgICAgICAgICB2YXIgcCA9ICQoJzxwPjwvcD4nKS50ZXh0KGFuc3dlci50ZXh0KS5hZGRDbGFzcyhpdGVtLmFuc3dlckNsYXNzKTtcbiAgICAgICAgICAgIHZhciBjID0gJCgnPGlucHV0PicpLmF0dHIoJ25hbWUnLCAnYW5zd2VyX29uX3F1ZXN0aW9uJyArIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3F1ZXN0aW9uX2lkJywgaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigndHlwZScsICdjaGVja2JveCcpLmF0dHIoJ3ZhbHVlJywgYW5zd2VyLmlkKTtcbiAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgY2hlY2tib3ggZm9yIG90aGVyIGFkZCBvdGhlciBpbnB1dFxuICAgICAgICAgICAgaWYgKGFuc3dlci5vdGhlcikge1xuICAgICAgICAgICAgICAgIGMuYXR0cignY2FuX290aGVyJywgJ3RydWUnKTtcbiAgICAgICAgICAgICAgICB2YXIgdHh0ID0gJCgnPGlucHV0PicpLmFkZENsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKS5hdHRyKCd0eXBlJywgJ3RleHQnKS5hdHRyKFwib3RoZXJfaW5wdXRcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgICAgIHAuYXBwZW5kKHR4dCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGMuY2xpY2soZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSBlcnJvciBjbGFzcyBpbiB3ZSBjaGFuZ2UgdmFsdWVcbiAgICAgICAgICAgICAgICB1bnNldEVycm9yKCQodGhpcykuYXR0cigncXVlc3Rpb25faWQnKSk7XG4gICAgICAgICAgICAgICAgLy8gaWYgY2hlY2sgIGNoZWNrYm94IHdpdGggb3RoZXIgYXR0ciBzaG93IG90aGVyIGlucHV0XG4gICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIHVuY2hlY2sgaGlkZSAgb3RoZXIgaW5wdXRcbiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5zaWJsaW5ncygpLnRvZ2dsZUNsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIGlucHV0IHJvb3RcbiAgICAgICAgICAgIHAucHJlcGVuZChjKTtcbiAgICAgICAgICAgIGNvbnRlbnQuYXBwZW5kKHApO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcbiAgICAgICAgLy8gcmV0dXJuIGlucHV0IGJsb2NrXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxuXG4gICAgfTtcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHZhciBjcmVhdGVSYWRpb0dyb3VwID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XG4gICAgICAgIHZhciBkaXZfaXRlbSA9ICQoJzxkaXY+PC9kaXY+Jyk7XG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uLmlkKSBkaXZfaXRlbS5hdHRyKCdqc19xel9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpO1xuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXG4gICAgICAgIHZhciBoZWFkZXIgPSAkKCc8aDM+PC9oMz4nKS50ZXh0KGl0ZW0ucXVlc3Rpb24udGV4dCk7XG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uQ2xhc3MpIGhlYWRlci5hZGRDbGFzcyhpdGVtLnF1ZXN0aW9uQ2xhc3MpO1xuICAgICAgICAvLyBjcmVhdGUgaW5wdXQgcm9vdFxuICAgICAgICB2YXIgY29udGVudCA9ICQoJzxkaXY+PC9kaXY+Jyk7XG5cbiAgICAgICAgLy8gY3JlYXRlIHJhZGlvIGZvciBlYWNoIGFuc3dlclxuICAgICAgICBpdGVtLnF1ZXN0aW9uLmFuc3dlcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5zd2VyKSB7XG4gICAgICAgICAgICB2YXIgcCA9ICQoJzxwPjwvcD4nKS50ZXh0KGFuc3dlci50ZXh0KS5hZGRDbGFzcyhpdGVtLmFuc3dlckNsYXNzKTtcbiAgICAgICAgICAgIHZhciByID0gJCgnPGlucHV0PicpLmF0dHIoJ25hbWUnLCAnYW5zd2VyX29uX3F1ZXN0aW9uJyArIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3F1ZXN0aW9uX2lkJywgaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigndHlwZScsICdyYWRpbycpLmF0dHIoJ3ZhbHVlJywgYW5zd2VyLmlkKTtcbiAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgY2hlY2tib3ggZm9yIG90aGVyIGFkZCBvdGhlciBpbnB1dFxuICAgICAgICAgICAgaWYgKGFuc3dlci5vdGhlcikge1xuICAgICAgICAgICAgICAgIHIuYXR0cignY2FuX290aGVyJywgJ3RydWUnKTtcbiAgICAgICAgICAgICAgICB2YXIgdHh0ID0gJCgnPGlucHV0PicpLmFkZENsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKS5hdHRyKCd0eXBlJywgJ3RleHQnKS5hdHRyKFwib3RoZXJfaW5wdXRcIiwgXCJ0cnVlXCIpO1xuICAgICAgICAgICAgICAgIHAuYXBwZW5kKHR4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByLmNsaWNrKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXG4gICAgICAgICAgICAgICAgdW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIGNoZWNrICByYWRpbyB3aXRoIG90aGVyIGF0dHIgc2hvdyBvdGhlciBpbnB1dFxuICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoJ2pzX3F1aXpfb3RoZXJfaGlkZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgY2hlY2sgb3RoZXIgcmFkaW8gc2V0IHVuaXNpYmxlIGFsbCBvdGhlciBpbnB1dHNcbiAgICAgICAgICAgICAgICAgICAgJCgnZGl2W2pzX3F6X2lkPScgKyBpdGVtLnF1ZXN0aW9uLmlkICsgJ10nKS5maW5kKCdpbnB1dFtvdGhlcl9pbnB1dD1cInRydWVcIl0nKS5hZGRDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBjb25uZWN0IGFsbCB0byBpbnB1dCByb290XG4gICAgICAgICAgICBwLnByZXBlbmQocik7XG4gICAgICAgICAgICBjb250ZW50LmFwcGVuZChwKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcbiAgICAgICAgLy8gcmV0dXJuIGlucHV0IGJsb2NrXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxuICAgIH07XG5cblxuXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgIC8vIG1ldGhvZCBmb3IgcmV0dXJuaW5nIHZhbHVlcyBmcm9tIHF1aXpcbiAgICB0aGlzLmdldFZhbHVlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGlzX2Vycm9yID0gZmFsc2U7XG4gICAgICAgIHZhciBkYXRhID0gW107XG4gICAgICAgIHZhciBlcnJfbWFzX2lkID0gW107XG5cbiAgICAgICAgdGhpcy5kYXRhLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAncmFkaW9ncm91cCcpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2VsX2VsZW0gPSAkKFwiaW5wdXQ6cmFkaW9bbmFtZT1cIiArIFwiYW5zd2VyX29uX3F1ZXN0aW9uXCIgKyBpdGVtLnF1ZXN0aW9uLmlkICsgXCJdOmNoZWNrZWRcIik7XG4gICAgICAgICAgICAgICAgdmFyIHIgPSBzZWxfZWxlbS52YWwoKTtcbiAgICAgICAgICAgICAgICBpZiAociA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucmVxdWlyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycl9tYXNfaWQucHVzaChpdGVtLnF1ZXN0aW9uLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzX2Vycm9yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFt7fV19KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsX2VsZW0uYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3RoZXIgPSBzZWxfZWxlbS5zaWJsaW5ncygpLnZhbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3tpZDogciwgb3RoZXI6IG90aGVyfV19KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFt7aWQ6IHJ9XX0pO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAnY2hlY2tib3gnKSB7XG4gICAgICAgICAgICAgICAgdmFyIGMgPSAkKFwiaW5wdXRbbmFtZT1hbnN3ZXJfb25fcXVlc3Rpb25cIiArIGl0ZW0ucXVlc3Rpb24uaWQgKyBcIl06Y2hlY2tlZFwiKTsgIC8vIGFycmF5IG9mIGFuc3dlcnNcbiAgICAgICAgICAgICAgICBpZiAoYy5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW1wiXCJdfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgYy5lYWNoKGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG90aGVyID0gJCh0aGlzKS5zaWJsaW5ncygpLnZhbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKHtpZDogJCh0aGlzKS52YWwoKSwgb3RoZXI6IG90aGVyfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMucHVzaCh7aWQ6ICQodGhpcykudmFsKCl9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOiBpdGVtLnF1ZXN0aW9uLmlkLCBhbnN3ZXJzOiByZXN9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3RleHQnKSB7XG4gICAgICAgICAgICAgICAgdmFyIHQgPSAkKFwiaW5wdXQ6dGV4dFtuYW1lPWFuc3dlcl9vbl9xdWVzdGlvblwiICsgaXRlbS5xdWVzdGlvbi5pZCArIFwiXVwiKS52YWwoKTtcbiAgICAgICAgICAgICAgICBpZiAodC5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW1wiXCJdfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3t0ZXh0OiB0fV19KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3NlbGVjdCcpIHtcbiAgICAgICAgICAgICAgICB2YXIgcyA9ICQoJyNzZWxlY3RfJyArIGl0ZW0ucXVlc3Rpb24uaWQgKyAnIDpzZWxlY3RlZCcpLnZhbCgpO1xuICAgICAgICAgICAgICAgIGlmIChzID09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW1wiXCJdfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3tpZDogc31dfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuXG4gICAgICAgIC8vIGlmIGdsb2JhbCBzZXR0aW5ncyBzaG93IGVycm9yIGVuYWJsZWQgdGhlbiBzaG93IGl0XG4gICAgICAgIGlmICh0aGF0LnNob3dSZXF1aXJlRXJyb3IpIHtcbiAgICAgICAgICAgIGVycl9tYXNfaWQuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgICAgIHNldEVycm9yKGl0ZW0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLy8gcmV0dXJuIHJlc3VsdCBvciBlcnJvclxuICAgICAgICAgICAgZXJyb3I6IGlzX2Vycm9yLFxuICAgICAgICAgICAgZGF0YTogaXNfZXJyb3IgPyB7fSA6IGRhdGEsXG4gICAgICAgICAgICBlcnJvcnNfaWQ6IGlzX2Vycm9yID8gZXJyX21hc19pZCA6IFtdXG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgcnVuKHRoaXMpO1xufVxuXG5cbihmdW5jdGlvbiAoJCkge1xuICAgICQuZm4uY3JlYXRlUXVpeiA9IGZ1bmN0aW9uIChjb25maWcpIHtcbiAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuXG4gICAgICAgIHZhciBjb25mID0ge1xuICAgICAgICAgICAgZGF0YTogY29uZmlnLmRhdGEgfHwgW10sICAvLyBhcnJheSBvZiBxdWVzdGlvbiBvYmplY3RzIG9yIDEgb2JqIGlmIDEgcXVlc3Rpb25cbiAgICAgICAgICAgIHNob3dSZXF1aXJlRXJyb3I6ICgoISFjb25maWcuc2hvd1JlcXVpcmVFcnJvcikgfHwgKGNvbmZpZy5zaG93UmVxdWlyZUVycm9yID09IHVuZGVmaW5lZCkpID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICAgICAgc3VibWl0QnV0dG9uIDogY29uZmlnLnN1Ym1pdEJ1dHRvbiB8fCBmYWxzZSxcbiAgICAgICAgICAgIHN1Ym1pdEZ1bmN0aW9uIDogY29uZmlnLnN1Ym1pdEZ1bmN0aW9uIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHN1Ym1pdEJ1dHRvblRleHQgOiBjb25maWcuc3VibWl0QnV0dG9uVGV4dCB8fCBcIlN1Ym1pdFwiLFxuICAgICAgICAgICAgc3VibWl0QnV0dG9uQ2xhc3MgOiBjb25maWcuc3VibWl0QnV0dG9uQ2xhc3MgfHwgXCJcIixcbiAgICAgICAgICAgIGlkOiB1bmRlZmluZWRcblxuICAgICAgICB9O1xuXG5cbiAgICAgICAgaWYgKCghdGhpcy5zZWxlY3RvcikgfHwgKCF0aGlzLnNlbGVjdG9yWzBdID09ICcjJykpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgfVxuICAgICAgICBjb25mLmlkID0gdGhpcy5zZWxlY3RvcjtcblxuICAgICAgICByZXR1cm4gbmV3IEpTUXVpeihjb25mKTtcbiAgICB9O1xufSkoalF1ZXJ5KTtcblxuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
