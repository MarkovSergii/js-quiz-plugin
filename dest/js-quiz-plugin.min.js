/**
 * Created by user on 28.06.2016.
 */
'use strict';

function JSQuiz(config) {

    var that = this;
    // configuration
    this.id = config.id;
    this.showRequireError = config.showRequireError;

    this.data = [];
    if (Array.isArray(config.data)) {
        this.data = config.data;
    }
    else {
        this.data.push(config.data)
    }


    // system methods --------------------------------------------------
    // create quiz block select
    var run = function (it) {
        if (it.data.length != 0) {
            $(that.id).html("");
            it.data.forEach(function (item) {
                if ((item.question) && (item.question.id) && (item.question.text)) {
                    if (item.questionType == 'radiogroup') {
                        $(that.id).append(createRadioGroup(item));
                    }
                    if (item.questionType == 'checkbox') {
                        $(that.id).append(createCheckBox(item));
                    }
                    if (item.questionType == 'text') {
                        $(that.id).append(createText(item));
                    }
                    if (item.questionType == 'select') {
                        $(that.id).append(createSelect(item));
                    }
                }

            });


        }
    };

    var createSelect = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create select
        var content = $('<div></div>');
        var select = $('<select>').attr('question_id', item.question.id).addClass(item.answerClass).attr('id', 'select_' + item.question.id);
        item.question.answers.forEach(function (answer) {
            var o = $('<option></option>').text(answer.text).attr('value', answer.id);
            select.append(o);

        });
        // clear select
        select.prop('value', false);

        // delete error class in we change value
        select.change(function () {
            that.unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        content.append(select);
        div_item.append(header);
        div_item.append(content);
        // return select block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block input text
    var createText = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input
        var content = $('<div></div>');
        var p = $('<p></p>').addClass(item.answerClass);
        var t = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'text');
        // delete error class in we change value
        t.focus(function () {
            that.unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        p.prepend(t);
        content.append(p);
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block chekbox group
    var createCheckBox = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create chackboxs for each answer
        item.question.answers.forEach(function (answer) {
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var c = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'checkbox').attr('value', answer.id);
            // if we have checkbox for other add other input
            if (answer.other) {
                c.attr('can_other', 'true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type', 'text').attr("other_input", "true");
                p.append(txt);
            }

            c.click(function () {
                // delete error class in we change value
                that.unsetError($(this).attr('question_id'));
                // if check  checkbox with other attr show other input
                if ($(this).attr('can_other') == 'true') {
                    // if uncheck hide  other input
                    $(this).siblings().toggleClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(c);
            content.append(p);
        });
        // connect all to root div
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    var createRadioGroup = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create radio for each answer
        item.question.answers.forEach(function (answer) {
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var r = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'radio').attr('value', answer.id);
            // if we have checkbox for other add other input
            if (answer.other) {
                r.attr('can_other', 'true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type', 'text').attr("other_input", "true");
                p.append(txt);
            }
            r.click(function () {
                // delete error class in we change value
                that.unsetError($(this).attr('question_id'));

                if ($(this).attr('can_other') == 'true') {
                    // if check  radio with other attr show other input
                    $(this).siblings().removeClass('js_quiz_other_hide');
                }
                else {
                    // if check other radio set unisible all other inputs
                    $('div[js_qz_id=' + item.question.id + ']').find('input[other_input="true"]').addClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(r);
            content.append(p);
        });

        // connect all to root div
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item
    };

    var setError = function (id) {
        $('[js_qz_id = ' + id + ']').addClass('js_quiz_question_error_required');
    };
    var unsetError = function (id) {
        $('[js_qz_id = ' + id + ']').removeClass('js_quiz_question_error_required');
    };

    //------------------------------------------------------------------

    // method for returning values from quiz
    this.getValues = function () {
        var is_error = false;
        var data = [];
        var err_mas_id = [];

        this.data.forEach(function (item) {
            if (item.questionType == 'radiogroup') {
                var sel_elem = $("input:radio[name=" + "answer_on_question" + item.question.id + "]:checked");
                var r = sel_elem.val();
                if (r == undefined) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [{}]});
                    }

                }
                else {
                    if (sel_elem.attr('can_other') == 'true') {
                        var other = sel_elem.siblings().val();
                        data.push({question_id: item.question.id, answers: [{id: r, other: other}]});
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [{id: r}]});
                    }

                }

            }
            if (item.questionType == 'checkbox') {
                var c = $("input[name=answer_on_question" + item.question.id + "]:checked");  // array of answers
                if (c.length == 0) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }
                }
                else {
                    var res = [];
                    c.each(function () {

                        if ($(this).attr('can_other') == 'true') {
                            var other = $(this).siblings().val();
                            res.push({id: $(this).val(), other: other});
                        }
                        else {
                            res.push({id: $(this).val()});
                        }

                    });

                    data.push({question_id: item.question.id, answers: res});
                }
            }
            if (item.questionType == 'text') {
                var t = $("input:text[name=answer_on_question" + item.question.id + "]").val();
                if (t.length == 0) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }

                }
                else {
                    data.push({question_id: item.question.id, answers: [{text: t}]});
                }
            }
            if (item.questionType == 'select') {
                var s = $('#select_' + item.question.id + ' :selected').val();
                if (s == undefined) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }

                }
                else {
                    data.push({question_id: item.question.id, answers: [{id: s}]});
                }
            }
        });


        // if global settings show error enabled then show it
        if (that.showRequireError) {
            err_mas_id.forEach(function (item) {
                setError(item);
            });
        }

        return {
            // return result or error
            error: is_error,
            data: is_error ? {} : data,
            errors_id: is_error ? err_mas_id : []
        };
    };

    //------------------------------------------------------------------
    run(this);
}


(function ($) {
    $.fn.createQuiz = function (config) {
        config = config || {};

        var conf = {
            data: config.data || [],  // array of question objects or 1 obj if 1 question
            showRequireError: ((!!config.showRequireError) || (config.showRequireError == undefined)) ? true : false,
            id: undefined

        };


        if ((!this.selector) || (!this.selector[0] == '#')) {
            return undefined
        }
        conf.id = this.selector;

        return new JSQuiz(conf);
    };
})(jQuery);



//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzLXF1aXotcGx1Z2luLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImpzLXF1aXotcGx1Z2luLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjguMDYuMjAxNi5cclxuICovXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbmZ1bmN0aW9uIEpTUXVpeihjb25maWcpIHtcclxuXHJcbiAgICB2YXIgdGhhdCA9IHRoaXM7XHJcbiAgICAvLyBjb25maWd1cmF0aW9uXHJcbiAgICB0aGlzLmlkID0gY29uZmlnLmlkO1xyXG4gICAgdGhpcy5zaG93UmVxdWlyZUVycm9yID0gY29uZmlnLnNob3dSZXF1aXJlRXJyb3I7XHJcblxyXG4gICAgdGhpcy5kYXRhID0gW107XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShjb25maWcuZGF0YSkpIHtcclxuICAgICAgICB0aGlzLmRhdGEgPSBjb25maWcuZGF0YTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRoaXMuZGF0YS5wdXNoKGNvbmZpZy5kYXRhKVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvLyBzeXN0ZW0gbWV0aG9kcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgLy8gY3JlYXRlIHF1aXogYmxvY2sgc2VsZWN0XHJcbiAgICB2YXIgcnVuID0gZnVuY3Rpb24gKGl0KSB7XHJcbiAgICAgICAgaWYgKGl0LmRhdGEubGVuZ3RoICE9IDApIHtcclxuICAgICAgICAgICAgJCh0aGF0LmlkKS5odG1sKFwiXCIpO1xyXG4gICAgICAgICAgICBpdC5kYXRhLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIGlmICgoaXRlbS5xdWVzdGlvbikgJiYgKGl0ZW0ucXVlc3Rpb24uaWQpICYmIChpdGVtLnF1ZXN0aW9uLnRleHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdyYWRpb2dyb3VwJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoYXQuaWQpLmFwcGVuZChjcmVhdGVSYWRpb0dyb3VwKGl0ZW0pKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdjaGVja2JveCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGF0LmlkKS5hcHBlbmQoY3JlYXRlQ2hlY2tCb3goaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3RleHQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGNyZWF0ZVRleHQoaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3NlbGVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGF0LmlkKS5hcHBlbmQoY3JlYXRlU2VsZWN0KGl0ZW0pKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgdmFyIGNyZWF0ZVNlbGVjdCA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XHJcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbi5pZCkgZGl2X2l0ZW0uYXR0cignanNfcXpfaWQnLCBpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXHJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbkNsYXNzKSBoZWFkZXIuYWRkQ2xhc3MoaXRlbS5xdWVzdGlvbkNsYXNzKTtcclxuICAgICAgICAvLyBjcmVhdGUgc2VsZWN0XHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIHZhciBzZWxlY3QgPSAkKCc8c2VsZWN0PicpLmF0dHIoJ3F1ZXN0aW9uX2lkJywgaXRlbS5xdWVzdGlvbi5pZCkuYWRkQ2xhc3MoaXRlbS5hbnN3ZXJDbGFzcykuYXR0cignaWQnLCAnc2VsZWN0XycgKyBpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICBpdGVtLnF1ZXN0aW9uLmFuc3dlcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5zd2VyKSB7XHJcbiAgICAgICAgICAgIHZhciBvID0gJCgnPG9wdGlvbj48L29wdGlvbj4nKS50ZXh0KGFuc3dlci50ZXh0KS5hdHRyKCd2YWx1ZScsIGFuc3dlci5pZCk7XHJcbiAgICAgICAgICAgIHNlbGVjdC5hcHBlbmQobyk7XHJcblxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGNsZWFyIHNlbGVjdFxyXG4gICAgICAgIHNlbGVjdC5wcm9wKCd2YWx1ZScsIGZhbHNlKTtcclxuXHJcbiAgICAgICAgLy8gZGVsZXRlIGVycm9yIGNsYXNzIGluIHdlIGNoYW5nZSB2YWx1ZVxyXG4gICAgICAgIHNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB0aGF0LnVuc2V0RXJyb3IoJCh0aGlzKS5hdHRyKCdxdWVzdGlvbl9pZCcpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBjb25uZWN0IGFsbCB0byByb290IGRpdlxyXG4gICAgICAgIGNvbnRlbnQuYXBwZW5kKHNlbGVjdCk7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIC8vIHJldHVybiBzZWxlY3QgYmxvY2tcclxuICAgICAgICByZXR1cm4gZGl2X2l0ZW1cclxuXHJcbiAgICB9O1xyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIC8vIGNyZWF0ZSBxdWl6IGJsb2NrIGlucHV0IHRleHRcclxuICAgIHZhciBjcmVhdGVUZXh0ID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAvLyBjcmVhdGUgcm9vdCBkaXZcclxuICAgICAgICB2YXIgZGl2X2l0ZW0gPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uLmlkKSBkaXZfaXRlbS5hdHRyKCdqc19xel9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBoZWFkZXJcclxuICAgICAgICB2YXIgaGVhZGVyID0gJCgnPGgzPjwvaDM+JykudGV4dChpdGVtLnF1ZXN0aW9uLnRleHQpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uQ2xhc3MpIGhlYWRlci5hZGRDbGFzcyhpdGVtLnF1ZXN0aW9uQ2xhc3MpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBpbnB1dFxyXG4gICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICB2YXIgcCA9ICQoJzxwPjwvcD4nKS5hZGRDbGFzcyhpdGVtLmFuc3dlckNsYXNzKTtcclxuICAgICAgICB2YXIgdCA9ICQoJzxpbnB1dD4nKS5hdHRyKCduYW1lJywgJ2Fuc3dlcl9vbl9xdWVzdGlvbicgKyBpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCdxdWVzdGlvbl9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3R5cGUnLCAndGV4dCcpO1xyXG4gICAgICAgIC8vIGRlbGV0ZSBlcnJvciBjbGFzcyBpbiB3ZSBjaGFuZ2UgdmFsdWVcclxuICAgICAgICB0LmZvY3VzKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhhdC51bnNldEVycm9yKCQodGhpcykuYXR0cigncXVlc3Rpb25faWQnKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcclxuICAgICAgICBwLnByZXBlbmQodCk7XHJcbiAgICAgICAgY29udGVudC5hcHBlbmQocCk7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIC8vIHJldHVybiBpbnB1dCBibG9ja1xyXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxyXG5cclxuICAgIH07XHJcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgLy8gY3JlYXRlIHF1aXogYmxvY2sgY2hla2JveCBncm91cFxyXG4gICAgdmFyIGNyZWF0ZUNoZWNrQm94ID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAvLyBjcmVhdGUgcm9vdCBkaXZcclxuICAgICAgICB2YXIgZGl2X2l0ZW0gPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uLmlkKSBkaXZfaXRlbS5hdHRyKCdqc19xel9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBoZWFkZXJcclxuICAgICAgICB2YXIgaGVhZGVyID0gJCgnPGgzPjwvaDM+JykudGV4dChpdGVtLnF1ZXN0aW9uLnRleHQpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uQ2xhc3MpIGhlYWRlci5hZGRDbGFzcyhpdGVtLnF1ZXN0aW9uQ2xhc3MpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBpbnB1dCByb290XHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG5cclxuICAgICAgICAvLyBjcmVhdGUgY2hhY2tib3hzIGZvciBlYWNoIGFuc3dlclxyXG4gICAgICAgIGl0ZW0ucXVlc3Rpb24uYW5zd2Vycy5mb3JFYWNoKGZ1bmN0aW9uIChhbnN3ZXIpIHtcclxuICAgICAgICAgICAgdmFyIHAgPSAkKCc8cD48L3A+JykudGV4dChhbnN3ZXIudGV4dCkuYWRkQ2xhc3MoaXRlbS5hbnN3ZXJDbGFzcyk7XHJcbiAgICAgICAgICAgIHZhciBjID0gJCgnPGlucHV0PicpLmF0dHIoJ25hbWUnLCAnYW5zd2VyX29uX3F1ZXN0aW9uJyArIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3F1ZXN0aW9uX2lkJywgaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigndHlwZScsICdjaGVja2JveCcpLmF0dHIoJ3ZhbHVlJywgYW5zd2VyLmlkKTtcclxuICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBjaGVja2JveCBmb3Igb3RoZXIgYWRkIG90aGVyIGlucHV0XHJcbiAgICAgICAgICAgIGlmIChhbnN3ZXIub3RoZXIpIHtcclxuICAgICAgICAgICAgICAgIGMuYXR0cignY2FuX290aGVyJywgJ3RydWUnKTtcclxuICAgICAgICAgICAgICAgIHZhciB0eHQgPSAkKCc8aW5wdXQ+JykuYWRkQ2xhc3MoJ2pzX3F1aXpfb3RoZXJfaGlkZScpLmF0dHIoJ3R5cGUnLCAndGV4dCcpLmF0dHIoXCJvdGhlcl9pbnB1dFwiLCBcInRydWVcIik7XHJcbiAgICAgICAgICAgICAgICBwLmFwcGVuZCh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSBlcnJvciBjbGFzcyBpbiB3ZSBjaGFuZ2UgdmFsdWVcclxuICAgICAgICAgICAgICAgIHRoYXQudW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xyXG4gICAgICAgICAgICAgICAgLy8gaWYgY2hlY2sgIGNoZWNrYm94IHdpdGggb3RoZXIgYXR0ciBzaG93IG90aGVyIGlucHV0XHJcbiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdjYW5fb3RoZXInKSA9PSAndHJ1ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpZiB1bmNoZWNrIGhpZGUgIG90aGVyIGlucHV0XHJcbiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5zaWJsaW5ncygpLnRvZ2dsZUNsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIGlucHV0IHJvb3RcclxuICAgICAgICAgICAgcC5wcmVwZW5kKGMpO1xyXG4gICAgICAgICAgICBjb250ZW50LmFwcGVuZChwKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBjb25uZWN0IGFsbCB0byByb290IGRpdlxyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChoZWFkZXIpO1xyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcclxuICAgICAgICAvLyByZXR1cm4gaW5wdXQgYmxvY2tcclxuICAgICAgICByZXR1cm4gZGl2X2l0ZW1cclxuXHJcbiAgICB9O1xyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIHZhciBjcmVhdGVSYWRpb0dyb3VwID0gZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAvLyBjcmVhdGUgcm9vdCBkaXZcclxuICAgICAgICB2YXIgZGl2X2l0ZW0gPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uLmlkKSBkaXZfaXRlbS5hdHRyKCdqc19xel9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBoZWFkZXJcclxuICAgICAgICB2YXIgaGVhZGVyID0gJCgnPGgzPjwvaDM+JykudGV4dChpdGVtLnF1ZXN0aW9uLnRleHQpO1xyXG4gICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uQ2xhc3MpIGhlYWRlci5hZGRDbGFzcyhpdGVtLnF1ZXN0aW9uQ2xhc3MpO1xyXG4gICAgICAgIC8vIGNyZWF0ZSBpbnB1dCByb290XHJcbiAgICAgICAgdmFyIGNvbnRlbnQgPSAkKCc8ZGl2PjwvZGl2PicpO1xyXG5cclxuICAgICAgICAvLyBjcmVhdGUgcmFkaW8gZm9yIGVhY2ggYW5zd2VyXHJcbiAgICAgICAgaXRlbS5xdWVzdGlvbi5hbnN3ZXJzLmZvckVhY2goZnVuY3Rpb24gKGFuc3dlcikge1xyXG4gICAgICAgICAgICB2YXIgcCA9ICQoJzxwPjwvcD4nKS50ZXh0KGFuc3dlci50ZXh0KS5hZGRDbGFzcyhpdGVtLmFuc3dlckNsYXNzKTtcclxuICAgICAgICAgICAgdmFyIHIgPSAkKCc8aW5wdXQ+JykuYXR0cignbmFtZScsICdhbnN3ZXJfb25fcXVlc3Rpb24nICsgaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigncXVlc3Rpb25faWQnLCBpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCd0eXBlJywgJ3JhZGlvJykuYXR0cigndmFsdWUnLCBhbnN3ZXIuaWQpO1xyXG4gICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIGNoZWNrYm94IGZvciBvdGhlciBhZGQgb3RoZXIgaW5wdXRcclxuICAgICAgICAgICAgaWYgKGFuc3dlci5vdGhlcikge1xyXG4gICAgICAgICAgICAgICAgci5hdHRyKCdjYW5fb3RoZXInLCAndHJ1ZScpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHR4dCA9ICQoJzxpbnB1dD4nKS5hZGRDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJykuYXR0cigndHlwZScsICd0ZXh0JykuYXR0cihcIm90aGVyX2lucHV0XCIsIFwidHJ1ZVwiKTtcclxuICAgICAgICAgICAgICAgIHAuYXBwZW5kKHR4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgci5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXHJcbiAgICAgICAgICAgICAgICB0aGF0LnVuc2V0RXJyb3IoJCh0aGlzKS5hdHRyKCdxdWVzdGlvbl9pZCcpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdjYW5fb3RoZXInKSA9PSAndHJ1ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpZiBjaGVjayAgcmFkaW8gd2l0aCBvdGhlciBhdHRyIHNob3cgb3RoZXIgaW5wdXRcclxuICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoJ2pzX3F1aXpfb3RoZXJfaGlkZScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgY2hlY2sgb3RoZXIgcmFkaW8gc2V0IHVuaXNpYmxlIGFsbCBvdGhlciBpbnB1dHNcclxuICAgICAgICAgICAgICAgICAgICAkKCdkaXZbanNfcXpfaWQ9JyArIGl0ZW0ucXVlc3Rpb24uaWQgKyAnXScpLmZpbmQoJ2lucHV0W290aGVyX2lucHV0PVwidHJ1ZVwiXScpLmFkZENsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIGlucHV0IHJvb3RcclxuICAgICAgICAgICAgcC5wcmVwZW5kKHIpO1xyXG4gICAgICAgICAgICBjb250ZW50LmFwcGVuZChwKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcclxuICAgICAgICBkaXZfaXRlbS5hcHBlbmQoaGVhZGVyKTtcclxuICAgICAgICBkaXZfaXRlbS5hcHBlbmQoY29udGVudCk7XHJcbiAgICAgICAgLy8gcmV0dXJuIGlucHV0IGJsb2NrXHJcbiAgICAgICAgcmV0dXJuIGRpdl9pdGVtXHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBzZXRFcnJvciA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgICQoJ1tqc19xel9pZCA9ICcgKyBpZCArICddJykuYWRkQ2xhc3MoJ2pzX3F1aXpfcXVlc3Rpb25fZXJyb3JfcmVxdWlyZWQnKTtcclxuICAgIH07XHJcbiAgICB2YXIgdW5zZXRFcnJvciA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgICQoJ1tqc19xel9pZCA9ICcgKyBpZCArICddJykucmVtb3ZlQ2xhc3MoJ2pzX3F1aXpfcXVlc3Rpb25fZXJyb3JfcmVxdWlyZWQnKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgICAvLyBtZXRob2QgZm9yIHJldHVybmluZyB2YWx1ZXMgZnJvbSBxdWl6XHJcbiAgICB0aGlzLmdldFZhbHVlcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgaXNfZXJyb3IgPSBmYWxzZTtcclxuICAgICAgICB2YXIgZGF0YSA9IFtdO1xyXG4gICAgICAgIHZhciBlcnJfbWFzX2lkID0gW107XHJcblxyXG4gICAgICAgIHRoaXMuZGF0YS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAncmFkaW9ncm91cCcpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzZWxfZWxlbSA9ICQoXCJpbnB1dDpyYWRpb1tuYW1lPVwiICsgXCJhbnN3ZXJfb25fcXVlc3Rpb25cIiArIGl0ZW0ucXVlc3Rpb24uaWQgKyBcIl06Y2hlY2tlZFwiKTtcclxuICAgICAgICAgICAgICAgIHZhciByID0gc2VsX2VsZW0udmFsKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAociA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJfbWFzX2lkLnB1c2goaXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzX2Vycm9yID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFt7fV19KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbF9lbGVtLmF0dHIoJ2Nhbl9vdGhlcicpID09ICd0cnVlJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3RoZXIgPSBzZWxfZWxlbS5zaWJsaW5ncygpLnZhbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOiBpdGVtLnF1ZXN0aW9uLmlkLCBhbnN3ZXJzOiBbe2lkOiByLCBvdGhlcjogb3RoZXJ9XX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3tpZDogcn1dfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdjaGVja2JveCcpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjID0gJChcImlucHV0W25hbWU9YW5zd2VyX29uX3F1ZXN0aW9uXCIgKyBpdGVtLnF1ZXN0aW9uLmlkICsgXCJdOmNoZWNrZWRcIik7ICAvLyBhcnJheSBvZiBhbnN3ZXJzXHJcbiAgICAgICAgICAgICAgICBpZiAoYy5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnJlcXVpcmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycl9tYXNfaWQucHVzaChpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW1wiXCJdfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGMuZWFjaChmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdjYW5fb3RoZXInKSA9PSAndHJ1ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvdGhlciA9ICQodGhpcykuc2libGluZ3MoKS52YWwoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5wdXNoKHtpZDogJCh0aGlzKS52YWwoKSwgb3RoZXI6IG90aGVyfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMucHVzaCh7aWQ6ICQodGhpcykudmFsKCl9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogcmVzfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICd0ZXh0Jykge1xyXG4gICAgICAgICAgICAgICAgdmFyIHQgPSAkKFwiaW5wdXQ6dGV4dFtuYW1lPWFuc3dlcl9vbl9xdWVzdGlvblwiICsgaXRlbS5xdWVzdGlvbi5pZCArIFwiXVwiKS52YWwoKTtcclxuICAgICAgICAgICAgICAgIGlmICh0Lmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucmVxdWlyZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19lcnJvciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOiBpdGVtLnF1ZXN0aW9uLmlkLCBhbnN3ZXJzOiBbXCJcIl19KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3t0ZXh0OiB0fV19KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3NlbGVjdCcpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzID0gJCgnI3NlbGVjdF8nICsgaXRlbS5xdWVzdGlvbi5pZCArICcgOnNlbGVjdGVkJykudmFsKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAocyA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJfbWFzX2lkLnB1c2goaXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzX2Vycm9yID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFtcIlwiXX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOiBpdGVtLnF1ZXN0aW9uLmlkLCBhbnN3ZXJzOiBbe2lkOiBzfV19KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgLy8gaWYgZ2xvYmFsIHNldHRpbmdzIHNob3cgZXJyb3IgZW5hYmxlZCB0aGVuIHNob3cgaXRcclxuICAgICAgICBpZiAodGhhdC5zaG93UmVxdWlyZUVycm9yKSB7XHJcbiAgICAgICAgICAgIGVycl9tYXNfaWQuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgc2V0RXJyb3IoaXRlbSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgLy8gcmV0dXJuIHJlc3VsdCBvciBlcnJvclxyXG4gICAgICAgICAgICBlcnJvcjogaXNfZXJyb3IsXHJcbiAgICAgICAgICAgIGRhdGE6IGlzX2Vycm9yID8ge30gOiBkYXRhLFxyXG4gICAgICAgICAgICBlcnJvcnNfaWQ6IGlzX2Vycm9yID8gZXJyX21hc19pZCA6IFtdXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIHJ1bih0aGlzKTtcclxufVxyXG5cclxuXHJcbihmdW5jdGlvbiAoJCkge1xyXG4gICAgJC5mbi5jcmVhdGVRdWl6ID0gZnVuY3Rpb24gKGNvbmZpZykge1xyXG4gICAgICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcclxuXHJcbiAgICAgICAgdmFyIGNvbmYgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IGNvbmZpZy5kYXRhIHx8IFtdLCAgLy8gYXJyYXkgb2YgcXVlc3Rpb24gb2JqZWN0cyBvciAxIG9iaiBpZiAxIHF1ZXN0aW9uXHJcbiAgICAgICAgICAgIHNob3dSZXF1aXJlRXJyb3I6ICgoISFjb25maWcuc2hvd1JlcXVpcmVFcnJvcikgfHwgKGNvbmZpZy5zaG93UmVxdWlyZUVycm9yID09IHVuZGVmaW5lZCkpID8gdHJ1ZSA6IGZhbHNlLFxyXG4gICAgICAgICAgICBpZDogdW5kZWZpbmVkXHJcblxyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgICAgICBpZiAoKCF0aGlzLnNlbGVjdG9yKSB8fCAoIXRoaXMuc2VsZWN0b3JbMF0gPT0gJyMnKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbmYuaWQgPSB0aGlzLnNlbGVjdG9yO1xyXG5cclxuICAgICAgICByZXR1cm4gbmV3IEpTUXVpeihjb25mKTtcclxuICAgIH07XHJcbn0pKGpRdWVyeSk7XHJcblxyXG5cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
