/**
 * Created by user on 28.06.2016.
 */
'use strict';

function JSQuiz(config) {

    var that = this;
    // configuration
    this.id = config.id;
    this.showRequireError = config.showRequireError;

    this.submitButton = config.submitButton;
    this.submitFunction = config.submitFunction;
    this.submitButtonClass = config.submitButtonClass;
    this.submitButtonText = config.submitButtonText;

    this.data = [];
    if (Array.isArray(config.data)) {
        this.data = config.data;
    }
    else {
        this.data.push(config.data)
    }


    // system methods --------------------------------------------------
    // create quiz
    var run = function (it) {
        if (it.data.length != 0) {
            $(that.id).html("");
            // create all blocks
            it.data.forEach(function (item) {
                if ((item.question) && (item.question.id) && (item.question.text)) {
                    if (item.questionType == 'radiogroup') {
                        $(that.id).append(createRadioGroup(item));
                    }
                    if (item.questionType == 'checkbox') {
                        $(that.id).append(createCheckBox(item));
                    }
                    if (item.questionType == 'text') {
                        $(that.id).append(createText(item));
                    }
                    if (item.questionType == 'select') {
                        $(that.id).append(createSelect(item));
                    }
                }

            });
            // check if need create button
            if (it.submitButton)
            {
                var btn_div = $('<div></div>').addClass(it.submitButtonClass);
                var btn = $('<button></button>').text(it.submitButtonText).click(function(){

                    if (typeof it.submitFunction == 'function')
                    {
                        it.submitFunction.call(null,it.getValues());
                    }

                });

                btn_div.append(btn);
                $(that.id).append(btn_div);
            }


        }
    };

    var createSelect = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create select
        var content = $('<div></div>');
        var select = $('<select>').attr('question_id', item.question.id).addClass(item.answerClass).attr('id', 'select_' + item.question.id);
        item.question.answers.forEach(function (answer) {
            var o = $('<option></option>').text(answer.text).attr('value', answer.id);
            select.append(o);

        });
        // clear select
        select.prop('value', false);

        // delete error class in we change value
        select.change(function () {
            that.unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        content.append(select);
        div_item.append(header);
        div_item.append(content);
        // return select block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block input text
    var createText = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input
        var content = $('<div></div>');
        var p = $('<p></p>').addClass(item.answerClass);
        var t = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'text');
        // delete error class in we change value
        t.focus(function () {
            that.unsetError($(this).attr('question_id'));
        });
        // connect all to root div
        p.prepend(t);
        content.append(p);
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    // create quiz block chekbox group
    var createCheckBox = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create chackboxs for each answer
        item.question.answers.forEach(function (answer) {
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var c = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'checkbox').attr('value', answer.id);
            // if we have checkbox for other add other input
            if (answer.other) {
                c.attr('can_other', 'true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type', 'text').attr("other_input", "true");
                p.append(txt);
            }

            c.click(function () {
                // delete error class in we change value
                that.unsetError($(this).attr('question_id'));
                // if check  checkbox with other attr show other input
                if ($(this).attr('can_other') == 'true') {
                    // if uncheck hide  other input
                    $(this).siblings().toggleClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(c);
            content.append(p);
        });
        // connect all to root div
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item

    };
    //------------------------------------------------------------------
    var createRadioGroup = function (item) {
        // create root div
        var div_item = $('<div></div>');
        if (item.question.id) div_item.attr('js_qz_id', item.question.id);
        // create header
        var header = $('<h3></h3>').text(item.question.text);
        if (item.questionClass) header.addClass(item.questionClass);
        // create input root
        var content = $('<div></div>');

        // create radio for each answer
        item.question.answers.forEach(function (answer) {
            var p = $('<p></p>').text(answer.text).addClass(item.answerClass);
            var r = $('<input>').attr('name', 'answer_on_question' + item.question.id).attr('question_id', item.question.id).attr('type', 'radio').attr('value', answer.id);
            // if we have checkbox for other add other input
            if (answer.other) {
                r.attr('can_other', 'true');
                var txt = $('<input>').addClass('js_quiz_other_hide').attr('type', 'text').attr("other_input", "true");
                p.append(txt);
            }
            r.click(function () {
                // delete error class in we change value
                that.unsetError($(this).attr('question_id'));

                if ($(this).attr('can_other') == 'true') {
                    // if check  radio with other attr show other input
                    $(this).siblings().removeClass('js_quiz_other_hide');
                }
                else {
                    // if check other radio set unisible all other inputs
                    $('div[js_qz_id=' + item.question.id + ']').find('input[other_input="true"]').addClass('js_quiz_other_hide');
                }
            });
            // connect all to input root
            p.prepend(r);
            content.append(p);
        });

        // connect all to root div
        div_item.append(header);
        div_item.append(content);
        // return input block
        return div_item
    };

    var setError = function (id) {
        $('[js_qz_id = ' + id + ']').addClass('js_quiz_question_error_required');
    };
    var unsetError = function (id) {
        $('[js_qz_id = ' + id + ']').removeClass('js_quiz_question_error_required');
    };

    //------------------------------------------------------------------

    // method for returning values from quiz
    this.getValues = function () {
        var is_error = false;
        var data = [];
        var err_mas_id = [];

        this.data.forEach(function (item) {
            if (item.questionType == 'radiogroup') {
                var sel_elem = $("input:radio[name=" + "answer_on_question" + item.question.id + "]:checked");
                var r = sel_elem.val();
                if (r == undefined) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [{}]});
                    }

                }
                else {
                    if (sel_elem.attr('can_other') == 'true') {
                        var other = sel_elem.siblings().val();
                        data.push({question_id: item.question.id, answers: [{id: r, other: other}]});
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [{id: r}]});
                    }

                }

            }
            if (item.questionType == 'checkbox') {
                var c = $("input[name=answer_on_question" + item.question.id + "]:checked");  // array of answers
                if (c.length == 0) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }
                }
                else {
                    var res = [];
                    c.each(function () {

                        if ($(this).attr('can_other') == 'true') {
                            var other = $(this).siblings().val();
                            res.push({id: $(this).val(), other: other});
                        }
                        else {
                            res.push({id: $(this).val()});
                        }

                    });

                    data.push({question_id: item.question.id, answers: res});
                }
            }
            if (item.questionType == 'text') {
                var t = $("input:text[name=answer_on_question" + item.question.id + "]").val();
                if (t.length == 0) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }

                }
                else {
                    data.push({question_id: item.question.id, answers: [{text: t}]});
                }
            }
            if (item.questionType == 'select') {
                var s = $('#select_' + item.question.id + ' :selected').val();
                if (s == undefined) {
                    if (item.required) {
                        err_mas_id.push(item.question.id);
                        is_error = true;
                    }
                    else {
                        data.push({question_id: item.question.id, answers: [""]});
                    }

                }
                else {
                    data.push({question_id: item.question.id, answers: [{id: s}]});
                }
            }
        });


        // if global settings show error enabled then show it
        if (that.showRequireError) {
            err_mas_id.forEach(function (item) {
                setError(item);
            });
        }

        return {
            // return result or error
            error: is_error,
            data: is_error ? {} : data,
            errors_id: is_error ? err_mas_id : []
        };
    };

    //------------------------------------------------------------------
    run(this);
}


(function ($) {
    $.fn.createQuiz = function (config) {
        config = config || {};

        var conf = {
            data: config.data || [],  // array of question objects or 1 obj if 1 question
            showRequireError: ((!!config.showRequireError) || (config.showRequireError == undefined)) ? true : false,
            submitButton : config.submitButton || false,
            submitFunction : config.submitFunction || undefined,
            submitButtonText : config.submitButtonText || "Submit",
            submitButtonClass : config.submitButtonClass || "",
            id: undefined

        };


        if ((!this.selector) || (!this.selector[0] == '#')) {
            return undefined
        }
        conf.id = this.selector;

        return new JSQuiz(conf);
    };
})(jQuery);



//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzLXF1aXotcGx1Z2luLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJqcy1xdWl6LXBsdWdpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDI4LjA2LjIwMTYuXHJcbiAqL1xyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5mdW5jdGlvbiBKU1F1aXooY29uZmlnKSB7XHJcblxyXG4gICAgdmFyIHRoYXQgPSB0aGlzO1xyXG4gICAgLy8gY29uZmlndXJhdGlvblxyXG4gICAgdGhpcy5pZCA9IGNvbmZpZy5pZDtcclxuICAgIHRoaXMuc2hvd1JlcXVpcmVFcnJvciA9IGNvbmZpZy5zaG93UmVxdWlyZUVycm9yO1xyXG5cclxuICAgIHRoaXMuc3VibWl0QnV0dG9uID0gY29uZmlnLnN1Ym1pdEJ1dHRvbjtcclxuICAgIHRoaXMuc3VibWl0RnVuY3Rpb24gPSBjb25maWcuc3VibWl0RnVuY3Rpb247XHJcbiAgICB0aGlzLnN1Ym1pdEJ1dHRvbkNsYXNzID0gY29uZmlnLnN1Ym1pdEJ1dHRvbkNsYXNzO1xyXG4gICAgdGhpcy5zdWJtaXRCdXR0b25UZXh0ID0gY29uZmlnLnN1Ym1pdEJ1dHRvblRleHQ7XHJcblxyXG4gICAgdGhpcy5kYXRhID0gW107XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShjb25maWcuZGF0YSkpIHtcclxuICAgICAgICB0aGlzLmRhdGEgPSBjb25maWcuZGF0YTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRoaXMuZGF0YS5wdXNoKGNvbmZpZy5kYXRhKVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvLyBzeXN0ZW0gbWV0aG9kcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgLy8gY3JlYXRlIHF1aXpcclxuICAgIHZhciBydW4gPSBmdW5jdGlvbiAoaXQpIHtcclxuICAgICAgICBpZiAoaXQuZGF0YS5sZW5ndGggIT0gMCkge1xyXG4gICAgICAgICAgICAkKHRoYXQuaWQpLmh0bWwoXCJcIik7XHJcbiAgICAgICAgICAgIC8vIGNyZWF0ZSBhbGwgYmxvY2tzXHJcbiAgICAgICAgICAgIGl0LmRhdGEuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKChpdGVtLnF1ZXN0aW9uKSAmJiAoaXRlbS5xdWVzdGlvbi5pZCkgJiYgKGl0ZW0ucXVlc3Rpb24udGV4dCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3JhZGlvZ3JvdXAnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGNyZWF0ZVJhZGlvR3JvdXAoaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ2NoZWNrYm94Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoYXQuaWQpLmFwcGVuZChjcmVhdGVDaGVja0JveChpdGVtKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAndGV4dCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGF0LmlkKS5hcHBlbmQoY3JlYXRlVGV4dChpdGVtKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAnc2VsZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoYXQuaWQpLmFwcGVuZChjcmVhdGVTZWxlY3QoaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyBjaGVjayBpZiBuZWVkIGNyZWF0ZSBidXR0b25cclxuICAgICAgICAgICAgaWYgKGl0LnN1Ym1pdEJ1dHRvbilcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdmFyIGJ0bl9kaXYgPSAkKCc8ZGl2PjwvZGl2PicpLmFkZENsYXNzKGl0LnN1Ym1pdEJ1dHRvbkNsYXNzKTtcclxuICAgICAgICAgICAgICAgIHZhciBidG4gPSAkKCc8YnV0dG9uPjwvYnV0dG9uPicpLnRleHQoaXQuc3VibWl0QnV0dG9uVGV4dCkuY2xpY2soZnVuY3Rpb24oKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdC5zdWJtaXRGdW5jdGlvbiA9PSAnZnVuY3Rpb24nKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXQuc3VibWl0RnVuY3Rpb24uY2FsbChudWxsLGl0LmdldFZhbHVlcygpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgYnRuX2Rpdi5hcHBlbmQoYnRuKTtcclxuICAgICAgICAgICAgICAgICQodGhhdC5pZCkuYXBwZW5kKGJ0bl9kaXYpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBjcmVhdGVTZWxlY3QgPSBmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgIC8vIGNyZWF0ZSByb290IGRpdlxyXG4gICAgICAgIHZhciBkaXZfaXRlbSA9ICQoJzxkaXY+PC9kaXY+Jyk7XHJcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb24uaWQpIGRpdl9pdGVtLmF0dHIoJ2pzX3F6X2lkJywgaXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgLy8gY3JlYXRlIGhlYWRlclxyXG4gICAgICAgIHZhciBoZWFkZXIgPSAkKCc8aDM+PC9oMz4nKS50ZXh0KGl0ZW0ucXVlc3Rpb24udGV4dCk7XHJcbiAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25DbGFzcykgaGVhZGVyLmFkZENsYXNzKGl0ZW0ucXVlc3Rpb25DbGFzcyk7XHJcbiAgICAgICAgLy8gY3JlYXRlIHNlbGVjdFxyXG4gICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICB2YXIgc2VsZWN0ID0gJCgnPHNlbGVjdD4nKS5hdHRyKCdxdWVzdGlvbl9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpLmFkZENsYXNzKGl0ZW0uYW5zd2VyQ2xhc3MpLmF0dHIoJ2lkJywgJ3NlbGVjdF8nICsgaXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgaXRlbS5xdWVzdGlvbi5hbnN3ZXJzLmZvckVhY2goZnVuY3Rpb24gKGFuc3dlcikge1xyXG4gICAgICAgICAgICB2YXIgbyA9ICQoJzxvcHRpb24+PC9vcHRpb24+JykudGV4dChhbnN3ZXIudGV4dCkuYXR0cigndmFsdWUnLCBhbnN3ZXIuaWQpO1xyXG4gICAgICAgICAgICBzZWxlY3QuYXBwZW5kKG8pO1xyXG5cclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBjbGVhciBzZWxlY3RcclxuICAgICAgICBzZWxlY3QucHJvcCgndmFsdWUnLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIC8vIGRlbGV0ZSBlcnJvciBjbGFzcyBpbiB3ZSBjaGFuZ2UgdmFsdWVcclxuICAgICAgICBzZWxlY3QuY2hhbmdlKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhhdC51bnNldEVycm9yKCQodGhpcykuYXR0cigncXVlc3Rpb25faWQnKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcclxuICAgICAgICBjb250ZW50LmFwcGVuZChzZWxlY3QpO1xyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChoZWFkZXIpO1xyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcclxuICAgICAgICAvLyByZXR1cm4gc2VsZWN0IGJsb2NrXHJcbiAgICAgICAgcmV0dXJuIGRpdl9pdGVtXHJcblxyXG4gICAgfTtcclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICAvLyBjcmVhdGUgcXVpeiBibG9jayBpbnB1dCB0ZXh0XHJcbiAgICB2YXIgY3JlYXRlVGV4dCA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XHJcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbi5pZCkgZGl2X2l0ZW0uYXR0cignanNfcXpfaWQnLCBpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXHJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbkNsYXNzKSBoZWFkZXIuYWRkQ2xhc3MoaXRlbS5xdWVzdGlvbkNsYXNzKTtcclxuICAgICAgICAvLyBjcmVhdGUgaW5wdXRcclxuICAgICAgICB2YXIgY29udGVudCA9ICQoJzxkaXY+PC9kaXY+Jyk7XHJcbiAgICAgICAgdmFyIHAgPSAkKCc8cD48L3A+JykuYWRkQ2xhc3MoaXRlbS5hbnN3ZXJDbGFzcyk7XHJcbiAgICAgICAgdmFyIHQgPSAkKCc8aW5wdXQ+JykuYXR0cignbmFtZScsICdhbnN3ZXJfb25fcXVlc3Rpb24nICsgaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigncXVlc3Rpb25faWQnLCBpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCd0eXBlJywgJ3RleHQnKTtcclxuICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXHJcbiAgICAgICAgdC5mb2N1cyhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHRoYXQudW5zZXRFcnJvcigkKHRoaXMpLmF0dHIoJ3F1ZXN0aW9uX2lkJykpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIHJvb3QgZGl2XHJcbiAgICAgICAgcC5wcmVwZW5kKHQpO1xyXG4gICAgICAgIGNvbnRlbnQuYXBwZW5kKHApO1xyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChoZWFkZXIpO1xyXG4gICAgICAgIGRpdl9pdGVtLmFwcGVuZChjb250ZW50KTtcclxuICAgICAgICAvLyByZXR1cm4gaW5wdXQgYmxvY2tcclxuICAgICAgICByZXR1cm4gZGl2X2l0ZW1cclxuXHJcbiAgICB9O1xyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAgIC8vIGNyZWF0ZSBxdWl6IGJsb2NrIGNoZWtib3ggZ3JvdXBcclxuICAgIHZhciBjcmVhdGVDaGVja0JveCA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XHJcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbi5pZCkgZGl2X2l0ZW0uYXR0cignanNfcXpfaWQnLCBpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXHJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbkNsYXNzKSBoZWFkZXIuYWRkQ2xhc3MoaXRlbS5xdWVzdGlvbkNsYXNzKTtcclxuICAgICAgICAvLyBjcmVhdGUgaW5wdXQgcm9vdFxyXG4gICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIGNoYWNrYm94cyBmb3IgZWFjaCBhbnN3ZXJcclxuICAgICAgICBpdGVtLnF1ZXN0aW9uLmFuc3dlcnMuZm9yRWFjaChmdW5jdGlvbiAoYW5zd2VyKSB7XHJcbiAgICAgICAgICAgIHZhciBwID0gJCgnPHA+PC9wPicpLnRleHQoYW5zd2VyLnRleHQpLmFkZENsYXNzKGl0ZW0uYW5zd2VyQ2xhc3MpO1xyXG4gICAgICAgICAgICB2YXIgYyA9ICQoJzxpbnB1dD4nKS5hdHRyKCduYW1lJywgJ2Fuc3dlcl9vbl9xdWVzdGlvbicgKyBpdGVtLnF1ZXN0aW9uLmlkKS5hdHRyKCdxdWVzdGlvbl9pZCcsIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3R5cGUnLCAnY2hlY2tib3gnKS5hdHRyKCd2YWx1ZScsIGFuc3dlci5pZCk7XHJcbiAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgY2hlY2tib3ggZm9yIG90aGVyIGFkZCBvdGhlciBpbnB1dFxyXG4gICAgICAgICAgICBpZiAoYW5zd2VyLm90aGVyKSB7XHJcbiAgICAgICAgICAgICAgICBjLmF0dHIoJ2Nhbl9vdGhlcicsICd0cnVlJyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgdHh0ID0gJCgnPGlucHV0PicpLmFkZENsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKS5hdHRyKCd0eXBlJywgJ3RleHQnKS5hdHRyKFwib3RoZXJfaW5wdXRcIiwgXCJ0cnVlXCIpO1xyXG4gICAgICAgICAgICAgICAgcC5hcHBlbmQodHh0KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYy5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBkZWxldGUgZXJyb3IgY2xhc3MgaW4gd2UgY2hhbmdlIHZhbHVlXHJcbiAgICAgICAgICAgICAgICB0aGF0LnVuc2V0RXJyb3IoJCh0aGlzKS5hdHRyKCdxdWVzdGlvbl9pZCcpKTtcclxuICAgICAgICAgICAgICAgIC8vIGlmIGNoZWNrICBjaGVja2JveCB3aXRoIG90aGVyIGF0dHIgc2hvdyBvdGhlciBpbnB1dFxyXG4gICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdW5jaGVjayBoaWRlICBvdGhlciBpbnB1dFxyXG4gICAgICAgICAgICAgICAgICAgICQodGhpcykuc2libGluZ3MoKS50b2dnbGVDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyBjb25uZWN0IGFsbCB0byBpbnB1dCByb290XHJcbiAgICAgICAgICAgIHAucHJlcGVuZChjKTtcclxuICAgICAgICAgICAgY29udGVudC5hcHBlbmQocCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gY29ubmVjdCBhbGwgdG8gcm9vdCBkaXZcclxuICAgICAgICBkaXZfaXRlbS5hcHBlbmQoaGVhZGVyKTtcclxuICAgICAgICBkaXZfaXRlbS5hcHBlbmQoY29udGVudCk7XHJcbiAgICAgICAgLy8gcmV0dXJuIGlucHV0IGJsb2NrXHJcbiAgICAgICAgcmV0dXJuIGRpdl9pdGVtXHJcblxyXG4gICAgfTtcclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICB2YXIgY3JlYXRlUmFkaW9Hcm91cCA9IGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgLy8gY3JlYXRlIHJvb3QgZGl2XHJcbiAgICAgICAgdmFyIGRpdl9pdGVtID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbi5pZCkgZGl2X2l0ZW0uYXR0cignanNfcXpfaWQnLCBpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAvLyBjcmVhdGUgaGVhZGVyXHJcbiAgICAgICAgdmFyIGhlYWRlciA9ICQoJzxoMz48L2gzPicpLnRleHQoaXRlbS5xdWVzdGlvbi50ZXh0KTtcclxuICAgICAgICBpZiAoaXRlbS5xdWVzdGlvbkNsYXNzKSBoZWFkZXIuYWRkQ2xhc3MoaXRlbS5xdWVzdGlvbkNsYXNzKTtcclxuICAgICAgICAvLyBjcmVhdGUgaW5wdXQgcm9vdFxyXG4gICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIHJhZGlvIGZvciBlYWNoIGFuc3dlclxyXG4gICAgICAgIGl0ZW0ucXVlc3Rpb24uYW5zd2Vycy5mb3JFYWNoKGZ1bmN0aW9uIChhbnN3ZXIpIHtcclxuICAgICAgICAgICAgdmFyIHAgPSAkKCc8cD48L3A+JykudGV4dChhbnN3ZXIudGV4dCkuYWRkQ2xhc3MoaXRlbS5hbnN3ZXJDbGFzcyk7XHJcbiAgICAgICAgICAgIHZhciByID0gJCgnPGlucHV0PicpLmF0dHIoJ25hbWUnLCAnYW5zd2VyX29uX3F1ZXN0aW9uJyArIGl0ZW0ucXVlc3Rpb24uaWQpLmF0dHIoJ3F1ZXN0aW9uX2lkJywgaXRlbS5xdWVzdGlvbi5pZCkuYXR0cigndHlwZScsICdyYWRpbycpLmF0dHIoJ3ZhbHVlJywgYW5zd2VyLmlkKTtcclxuICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBjaGVja2JveCBmb3Igb3RoZXIgYWRkIG90aGVyIGlucHV0XHJcbiAgICAgICAgICAgIGlmIChhbnN3ZXIub3RoZXIpIHtcclxuICAgICAgICAgICAgICAgIHIuYXR0cignY2FuX290aGVyJywgJ3RydWUnKTtcclxuICAgICAgICAgICAgICAgIHZhciB0eHQgPSAkKCc8aW5wdXQ+JykuYWRkQ2xhc3MoJ2pzX3F1aXpfb3RoZXJfaGlkZScpLmF0dHIoJ3R5cGUnLCAndGV4dCcpLmF0dHIoXCJvdGhlcl9pbnB1dFwiLCBcInRydWVcIik7XHJcbiAgICAgICAgICAgICAgICBwLmFwcGVuZCh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHIuY2xpY2soZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgLy8gZGVsZXRlIGVycm9yIGNsYXNzIGluIHdlIGNoYW5nZSB2YWx1ZVxyXG4gICAgICAgICAgICAgICAgdGhhdC51bnNldEVycm9yKCQodGhpcykuYXR0cigncXVlc3Rpb25faWQnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgY2hlY2sgIHJhZGlvIHdpdGggb3RoZXIgYXR0ciBzaG93IG90aGVyIGlucHV0XHJcbiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCdqc19xdWl6X290aGVyX2hpZGUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIGNoZWNrIG90aGVyIHJhZGlvIHNldCB1bmlzaWJsZSBhbGwgb3RoZXIgaW5wdXRzXHJcbiAgICAgICAgICAgICAgICAgICAgJCgnZGl2W2pzX3F6X2lkPScgKyBpdGVtLnF1ZXN0aW9uLmlkICsgJ10nKS5maW5kKCdpbnB1dFtvdGhlcl9pbnB1dD1cInRydWVcIl0nKS5hZGRDbGFzcygnanNfcXVpel9vdGhlcl9oaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyBjb25uZWN0IGFsbCB0byBpbnB1dCByb290XHJcbiAgICAgICAgICAgIHAucHJlcGVuZChyKTtcclxuICAgICAgICAgICAgY29udGVudC5hcHBlbmQocCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIGNvbm5lY3QgYWxsIHRvIHJvb3QgZGl2XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGhlYWRlcik7XHJcbiAgICAgICAgZGl2X2l0ZW0uYXBwZW5kKGNvbnRlbnQpO1xyXG4gICAgICAgIC8vIHJldHVybiBpbnB1dCBibG9ja1xyXG4gICAgICAgIHJldHVybiBkaXZfaXRlbVxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgc2V0RXJyb3IgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICAkKCdbanNfcXpfaWQgPSAnICsgaWQgKyAnXScpLmFkZENsYXNzKCdqc19xdWl6X3F1ZXN0aW9uX2Vycm9yX3JlcXVpcmVkJyk7XHJcbiAgICB9O1xyXG4gICAgdmFyIHVuc2V0RXJyb3IgPSBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICAkKCdbanNfcXpfaWQgPSAnICsgaWQgKyAnXScpLnJlbW92ZUNsYXNzKCdqc19xdWl6X3F1ZXN0aW9uX2Vycm9yX3JlcXVpcmVkJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4gICAgLy8gbWV0aG9kIGZvciByZXR1cm5pbmcgdmFsdWVzIGZyb20gcXVpelxyXG4gICAgdGhpcy5nZXRWYWx1ZXMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGlzX2Vycm9yID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIGRhdGEgPSBbXTtcclxuICAgICAgICB2YXIgZXJyX21hc19pZCA9IFtdO1xyXG5cclxuICAgICAgICB0aGlzLmRhdGEuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xyXG4gICAgICAgICAgICBpZiAoaXRlbS5xdWVzdGlvblR5cGUgPT0gJ3JhZGlvZ3JvdXAnKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc2VsX2VsZW0gPSAkKFwiaW5wdXQ6cmFkaW9bbmFtZT1cIiArIFwiYW5zd2VyX29uX3F1ZXN0aW9uXCIgKyBpdGVtLnF1ZXN0aW9uLmlkICsgXCJdOmNoZWNrZWRcIik7XHJcbiAgICAgICAgICAgICAgICB2YXIgciA9IHNlbF9lbGVtLnZhbCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHIgPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucmVxdWlyZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19lcnJvciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOiBpdGVtLnF1ZXN0aW9uLmlkLCBhbnN3ZXJzOiBbe31dfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxfZWxlbS5hdHRyKCdjYW5fb3RoZXInKSA9PSAndHJ1ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG90aGVyID0gc2VsX2VsZW0uc2libGluZ3MoKS52YWwoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3tpZDogciwgb3RoZXI6IG90aGVyfV19KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFt7aWQ6IHJ9XX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAnY2hlY2tib3gnKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYyA9ICQoXCJpbnB1dFtuYW1lPWFuc3dlcl9vbl9xdWVzdGlvblwiICsgaXRlbS5xdWVzdGlvbi5pZCArIFwiXTpjaGVja2VkXCIpOyAgLy8gYXJyYXkgb2YgYW5zd2Vyc1xyXG4gICAgICAgICAgICAgICAgaWYgKGMubGVuZ3RoID09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXF1aXJlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJfbWFzX2lkLnB1c2goaXRlbS5xdWVzdGlvbi5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzX2Vycm9yID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFtcIlwiXX0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICBjLmVhY2goZnVuY3Rpb24gKCkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignY2FuX290aGVyJykgPT0gJ3RydWUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3RoZXIgPSAkKHRoaXMpLnNpYmxpbmdzKCkudmFsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMucHVzaCh7aWQ6ICQodGhpcykudmFsKCksIG90aGVyOiBvdGhlcn0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnB1c2goe2lkOiAkKHRoaXMpLnZhbCgpfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IHJlc30pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpdGVtLnF1ZXN0aW9uVHlwZSA9PSAndGV4dCcpIHtcclxuICAgICAgICAgICAgICAgIHZhciB0ID0gJChcImlucHV0OnRleHRbbmFtZT1hbnN3ZXJfb25fcXVlc3Rpb25cIiArIGl0ZW0ucXVlc3Rpb24uaWQgKyBcIl1cIikudmFsKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodC5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnJlcXVpcmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycl9tYXNfaWQucHVzaChpdGVtLnF1ZXN0aW9uLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXJyb3IgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW1wiXCJdfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7cXVlc3Rpb25faWQ6IGl0ZW0ucXVlc3Rpb24uaWQsIGFuc3dlcnM6IFt7dGV4dDogdH1dfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0ucXVlc3Rpb25UeXBlID09ICdzZWxlY3QnKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcyA9ICQoJyNzZWxlY3RfJyArIGl0ZW0ucXVlc3Rpb24uaWQgKyAnIDpzZWxlY3RlZCcpLnZhbCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHMgPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucmVxdWlyZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyX21hc19pZC5wdXNoKGl0ZW0ucXVlc3Rpb24uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19lcnJvciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goe3F1ZXN0aW9uX2lkOiBpdGVtLnF1ZXN0aW9uLmlkLCBhbnN3ZXJzOiBbXCJcIl19KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHtxdWVzdGlvbl9pZDogaXRlbS5xdWVzdGlvbi5pZCwgYW5zd2VyczogW3tpZDogc31dfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIC8vIGlmIGdsb2JhbCBzZXR0aW5ncyBzaG93IGVycm9yIGVuYWJsZWQgdGhlbiBzaG93IGl0XHJcbiAgICAgICAgaWYgKHRoYXQuc2hvd1JlcXVpcmVFcnJvcikge1xyXG4gICAgICAgICAgICBlcnJfbWFzX2lkLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIHNldEVycm9yKGl0ZW0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIC8vIHJldHVybiByZXN1bHQgb3IgZXJyb3JcclxuICAgICAgICAgICAgZXJyb3I6IGlzX2Vycm9yLFxyXG4gICAgICAgICAgICBkYXRhOiBpc19lcnJvciA/IHt9IDogZGF0YSxcclxuICAgICAgICAgICAgZXJyb3JzX2lkOiBpc19lcnJvciA/IGVycl9tYXNfaWQgOiBbXVxyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG5cclxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICBydW4odGhpcyk7XHJcbn1cclxuXHJcblxyXG4oZnVuY3Rpb24gKCQpIHtcclxuICAgICQuZm4uY3JlYXRlUXVpeiA9IGZ1bmN0aW9uIChjb25maWcpIHtcclxuICAgICAgICBjb25maWcgPSBjb25maWcgfHwge307XHJcblxyXG4gICAgICAgIHZhciBjb25mID0ge1xyXG4gICAgICAgICAgICBkYXRhOiBjb25maWcuZGF0YSB8fCBbXSwgIC8vIGFycmF5IG9mIHF1ZXN0aW9uIG9iamVjdHMgb3IgMSBvYmogaWYgMSBxdWVzdGlvblxyXG4gICAgICAgICAgICBzaG93UmVxdWlyZUVycm9yOiAoKCEhY29uZmlnLnNob3dSZXF1aXJlRXJyb3IpIHx8IChjb25maWcuc2hvd1JlcXVpcmVFcnJvciA9PSB1bmRlZmluZWQpKSA/IHRydWUgOiBmYWxzZSxcclxuICAgICAgICAgICAgc3VibWl0QnV0dG9uIDogY29uZmlnLnN1Ym1pdEJ1dHRvbiB8fCBmYWxzZSxcclxuICAgICAgICAgICAgc3VibWl0RnVuY3Rpb24gOiBjb25maWcuc3VibWl0RnVuY3Rpb24gfHwgdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICBzdWJtaXRCdXR0b25UZXh0IDogY29uZmlnLnN1Ym1pdEJ1dHRvblRleHQgfHwgXCJTdWJtaXRcIixcclxuICAgICAgICAgICAgc3VibWl0QnV0dG9uQ2xhc3MgOiBjb25maWcuc3VibWl0QnV0dG9uQ2xhc3MgfHwgXCJcIixcclxuICAgICAgICAgICAgaWQ6IHVuZGVmaW5lZFxyXG5cclxuICAgICAgICB9O1xyXG5cclxuXHJcbiAgICAgICAgaWYgKCghdGhpcy5zZWxlY3RvcikgfHwgKCF0aGlzLnNlbGVjdG9yWzBdID09ICcjJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25mLmlkID0gdGhpcy5zZWxlY3RvcjtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBKU1F1aXooY29uZik7XHJcbiAgICB9O1xyXG59KShqUXVlcnkpO1xyXG5cclxuXHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
